<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Steampunk Duelist v10.0 - Reborn UI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Rye&display=swap" rel="stylesheet">
    <style>
        :root {
            --brass: #b5a642; --bronze: #cd7f32; --gold: #ffd700;
            --leather: #4a3c31; --parchment: #eaddcf; --steam-blue: #00f3ff;
            --danger: #ff4444; --success: #44ff44; --shield: #00aaff; --poison: #bf00ff;
            --boss-purple: #b300ff; --boss-red-bg: #3a0000;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0; background: #120f0d;
            color: var(--parchment); font-family: 'IM Fell English SC', serif;
            overflow: hidden; height: 100vh; width: 100vw; user-select: none;
            background-image: radial-gradient(circle, #2a221b 0%, #120f0d 100%);
            transition: background-image 1.5s ease-in-out; touch-action: manipulation;
            display: flex; flex-direction: column; /* ÊîπÁÇ∫ Flex ‰ΩàÂ±Ä */
        }

        body.boss-mode { background-image: radial-gradient(circle, #7a0000 0%, var(--boss-red-bg) 100%) !important; }

        /* --- 1. È†ÇÂ±§Ë≥áË®äÂçÄ (Top Bar) --- */
        #top-bar {
            width: 100%; height: 60px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; z-index: 100; pointer-events: none;
        }
        
        /* Ë∑ëÈ¶¨Ááà (ÁµïÂ∞çÂÆö‰ΩçÂú®ÊúÄÈ†Ç) */
        #marquee-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 30px;
            background: var(--danger); border-bottom: 2px solid var(--gold);
            color: #fff; overflow: hidden; z-index: 200; display: none;
        }
        body.boss-mode #marquee-container { display: block; }
        .marquee-content { display: flex; width: fit-content; animation: marquee-scroll 10s linear infinite; }
        .marquee-content span { white-space: nowrap; font-family: 'Rye'; font-size: 1rem; line-height: 30px; padding-right: 50px; }
        @keyframes marquee-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

        /* Â∑¶‰∏äËßíÂÑÄË°®Êùø */
        .dashboard-group { display: flex; gap: 15px; margin-top: 10px; pointer-events: auto; }
        .gauge-circle {
            width: 70px; height: 70px; border: 3px solid var(--brass); border-radius: 50%;
            background: radial-gradient(circle, var(--leather), #111);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .gauge-label { font-size: 0.6rem; color: #888; }
        .gauge-val { font-family: 'Rye'; font-size: 1.5rem; color: var(--steam-blue); }

        /* Âè≥‰∏äËßíÂõûÂêàÊï∏ */
        .round-box {
            width: 60px; height: 70px; background: var(--leather); border: 3px double var(--brass);
            border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin-top: 10px;
        }

        /* --- 2. ‰∏≠Â±§Êà∞È¨•ÂçÄ (Battle Area) --- */
        #battle-area {
            flex: 1; /* ‰ΩîÊìöÂâ©È§òÁ©∫Èñì */
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding-top: 40px; gap: 20px; position: relative; width: 100%;
        }

        /* Êïµ‰∫∫ÂçÄÂ°ä */
        .enemy-box {
            width: 400px; max-width: 90%; 
            background: #222; border: 6px ridge var(--bronze);
            padding: 15px 20px; border-radius: 8px; position: relative; cursor: pointer; transition: 0.3s;
            display: flex; flex-direction: column; gap: 5px;
        }
        .enemy-box.stunned { filter: grayscale(100%) brightness(0.7); border-color: #555 !important; }
        .tier-1 { border-color: #cd7f32 !important; }
        .tier-2 { border-color: #c0c0c0 !important; box-shadow: 0 0 20px rgba(192,192,192,0.3); }
        .tier-3 { border-color: #ffd700 !important; box-shadow: 0 0 35px rgba(255,215,0,0.5); }
        .tier-4 { border-color: var(--boss-purple) !important; box-shadow: 0 0 40px var(--boss-purple); animation: boss-pulse 1.5s infinite alternate; }
        @keyframes boss-pulse { from { box-shadow: 0 0 20px var(--boss-purple); } to { box-shadow: 0 0 50px var(--boss-purple); } }

        .target-active { outline: 3px solid var(--steam-blue); box-shadow: 0 0 30px var(--steam-blue); }

        /* Áé©ÂÆ∂ÂçÄÂ°ä (Áç®Á´ãÂá∫‰æÜ) */
        #player-box {
            width: 400px; max-width: 90%;
            padding: 10px; border-radius: 10px; transition: 0.2s; cursor: pointer;
            background: rgba(0,0,0,0.3); border: 1px solid transparent;
        }
        #player-box:hover { background: rgba(255,255,255,0.05); }

        /* ÈÄöÁî®Ë°ÄÊ¢ùÊ®£Âºè */
        .hp-bar-frame {
            width: 100%; height: 20px; background: #111; border: 2px solid var(--brass);
            border-radius: 10px; overflow: hidden; position: relative; margin-top: 5px;
        }
        .hp-fill { height: 100%; width: 100%; position: absolute; left: 0; top: 0; transition: 0.4s; }
        .shield-fill { height: 100%; width: 0%; background: var(--shield); opacity: 0.6; position: absolute; left: 0; top: 0; transition: 0.4s; z-index: 2; }
        
        .status-row { display: flex; gap: 4px; flex-wrap: wrap; min-height: 20px; }
        .status-tag { 
            padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; color: #fff; 
            border: 1px solid rgba(255,255,255,0.3); background: #444; 
            display: inline-flex; align-items: center; 
        }

        /* --- 3. Â∫ïÂ±§Êìç‰ΩúÂçÄ (Action Area) --- */
        #action-area {
            height: 240px; width: 100%; position: relative;
            display: flex; justify-content: center; align-items: flex-end;
            padding-bottom: 10px;
        }

        /* ÊâãÁâåÂÆπÂô® */
        #hand-container {
            width: 100%; height: 100%; display: flex; justify-content: center; align-items: flex-end;
            perspective: 1000px; padding-bottom: 20px; overflow: visible;
        }

        .card { 
            width: 130px; height: 190px; background: var(--parchment); color: #2a1a0a; 
            border: 4px solid var(--bronze); border-radius: 10px; margin: 0 -15px; 
            cursor: pointer; position: relative; transition: 0.25s; flex-shrink: 0;
            background-image: url('https://www.transparenttextures.com/patterns/pinstriped-suit.png');
            box-shadow: -5px 5px 15px rgba(0,0,0,0.5); transform-origin: center bottom;
        }
        .card:hover { transform: translateY(-50px) scale(1.1) !important; z-index: 100; margin: 0 5px; }
        .card.selected { transform: translateY(-80px) scale(1.15) !important; border-color: var(--steam-blue); box-shadow: 0 0 30px var(--steam-blue); z-index: 200; }
        
        .card-header { display: flex; justify-content: space-between; padding: 5px; }
        .card-cost { width: 28px; height: 28px; border-radius: 50%; background: #222; color: var(--steam-blue); border: 2px solid var(--steam-blue); display: flex; align-items: center; justify-content: center; font-family: 'Rye'; font-weight: bold; }
        .card-id { font-size: 0.6rem; color: #666; align-self: center; }
        .card-name { text-align: center; font-family: 'Rye'; font-size: 0.85rem; font-weight: bold; border-bottom: 1px solid #aaa; padding-bottom: 2px; margin: 0 5px; }
        .card-body { padding: 10px 5px; text-align: center; font-size: 0.7rem; color: #332; line-height: 1.25; font-weight: bold; }
        
        .tag { display: inline-block; padding: 1px 3px; border-radius: 3px; font-size: 0.65rem; margin: 1px; color: #fff; }
        .bg-dmg { background: #aa4444; } .bg-def { background: #0088cc; } .bg-heal { background: #44aa44; } 
        .bg-misc { background: #555; } .bg-req { background: #000; border: 1px solid #f00; color: #f00; }

        /* Â∑¶‰∏ãËßíÁâåÂ†Ü */
        #piles-ui {
            position: absolute; left: 20px; bottom: 20px; display: flex; gap: 10px; z-index: 50;
        }
        .pile-btn {
            width: 50px; height: 70px; background: #222; border: 2px solid var(--brass); border-radius: 5px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 2px 2px 5px #000;
        }
        .pile-btn:hover { border-color: #fff; }
        .pile-lbl { font-size: 0.6rem; color: #888; }
        .pile-num { font-family: 'Rye'; font-size: 1.2rem; color: #fff; }

        /* Âè≥‰∏ãËßíÊéßÂà∂ */
        #controls-ui {
            position: absolute; right: 20px; bottom: 20px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; z-index: 50;
        }
        #hand-count { font-family: 'Rye'; font-size: 1.5rem; color: #888; text-shadow: 1px 1px 0 #000; }
        #end-btn {
            width: 90px; height: 90px; border-radius: 50%; background: var(--bronze);
            border: 5px double var(--brass); color: #fff; font-family: 'Rye'; font-size: 1.2rem;
            cursor: pointer; box-shadow: 0 5px 15px #000; transition: 0.2s;
        }
        #end-btn:hover { transform: scale(1.05); background: #c57d3e; }

        /* ÊµÆÂãïË®äÊÅØ */
        #action-log { position: absolute; top: 40%; width: 100%; text-align: center; font-family: 'Rye'; font-size: 2rem; color: #fff; text-shadow: 0 0 10px #000; pointer-events: none; z-index: 500; transition: 0.3s; opacity: 0; }

        /* --- ÈÅÆÁΩ©ËàáÈÅéÂ†¥ --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .victory-title { font-family: 'Rye'; font-size: 3rem; color: var(--gold); margin-bottom: 20px; }
        .reward-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        .reward-card { width: 180px; height: 240px; background: #222; border: 2px solid var(--bronze); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: #eee; padding: 10px; text-align: center; }
        .reward-card:hover { border-color: var(--steam-blue); background: #333; }
        .reward-icon { font-size: 3rem; margin-bottom: 10px; }
        #viewer-grid { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; max-width: 90%; max-height: 70vh; overflow-y: auto; padding: 20px; }

        /* --- üì± RWD ÈüøÊáâÂºèË™øÊï¥ --- */
        
        /* 1. Âπ≥ÊùøËàáÂØ¨Ëû¢ÂπïÊâãÊ©ü (Ê©´Âêë) */
        @media (max-width: 1024px) {
            .enemy-box { width: 320px; padding: 10px; }
            #player-box { width: 320px; }
            .card { width: 110px; height: 160px; }
            #end-btn { width: 80px; height: 80px; font-size: 1rem; }
        }

        /* 2. ÊâãÊ©ü (Áõ¥Âêë) - ÂæπÂ∫ïÈáçÊéí */
        @media (max-width: 600px) {
            /* Â£ìÁ∏ÆÂÑÄË°®Êùø */
            .dashboard-group { gap: 8px; margin-left: 5px; }
            .gauge-circle { width: 50px; height: 50px; border-width: 2px; }
            .gauge-val { font-size: 1rem; }
            .round-box { width: 45px; height: 55px; margin-right: 5px; }

            /* Êà∞È¨•ÂçÄÁ∑äÊπäÊéíÂàó */
            #battle-area { padding-top: 50px; gap: 10px; justify-content: center; }
            
            .enemy-box { width: 90%; padding: 10px; }
            .enemy-name { font-size: 1.5rem; }
            
            #player-box { width: 90%; margin-top: 5px; }
            
            /* ÊâãÁâåÂçÄÁ∏ÆÂ∞è */
            #action-area { height: 180px; }
            .card { width: 90px; height: 130px; margin: 0 -10px; }
            .card-name { font-size: 0.6rem; padding: 5px 0; }
            .card-desc { font-size: 0.5rem; margin-top: 5px; padding: 0 2px; }
            .card-cost { width: 22px; height: 22px; font-size: 0.9rem; top: -8px; left: -8px; }

            /* ÊåâÈàïËàáË®àÊï∏ */
            #end-btn { width: 65px; height: 65px; font-size: 0.8rem; }
            #piles-ui { bottom: 120px; left: 10px; flex-direction: column; gap: 5px; } /* ÁâåÂ†ÜÁßªÂà∞Â∑¶ÂÅ¥‰∏äÊñπ‰∏ÄÈªû */
            .pile-btn { width: 40px; height: 50px; }
            #hand-counter { bottom: 85px; right: 15px; font-size: 1rem; } /* Ë®àÊï∏ÁßªÂà∞ÊåâÈàï‰∏äÊñπ */
            
            .reward-card { width: 140px; height: 180px; }
        }
    </style>
</head>
<body onload="init()">

    <div id="marquee-container"><div class="marquee-content"><span>‚ö† WARNING: BOSS APPROACHING ‚ö†</span><span>‚ö† WARNING: BOSS APPROACHING ‚ö†</span></div></div>
    
    <div id="top-bar">
        <div class="dashboard-group">
            <div class="gauge-circle"><span class="gauge-label">ENERGY</span><span id="ui-eng" class="gauge-val">3/3</span></div>
            <div class="gauge-circle"><span class="gauge-label">WAVE</span><span id="ui-wave" class="gauge-val">1</span></div>
        </div>
        <div class="round-box"><span style="font-size:0.5rem">ROUND</span><span id="ui-round" style="font-family:'Rye';font-size:1.2rem;color:var(--gold)">1</span></div>
    </div>

    <div id="battle-area">
        <div class="enemy-box tier-1" id="enemy-target">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div id="ui-en-name" style="font-family:'Rye'; font-size:1.8rem; line-height:1;">LOADING</div>
                <div id="ui-en-intent" style="color:var(--steam-blue); font-size:0.8rem;"></div>
            </div>
            <div id="en-status" class="status-row"></div>
            <div class="hp-bar-frame">
                <div id="ui-en-hp-fill" class="hp-fill" style="background:var(--danger);"></div>
            </div>
            <div id="ui-en-hp-text" style="text-align:right; font-size:0.8rem; color:#888;">-- / --</div>
        </div>

        <div id="player-box">
            <div style="display:flex; justify-content:space-between;">
                <span style="font-family:'Rye'; color:#aaa;">PLAYER CORE</span>
                <span id="ui-pl-hp-text" style="font-size:0.9rem;">100 / 100</span>
            </div>
            <div id="pl-status" class="status-row"></div>
            <div class="hp-bar-frame">
                <div id="ui-pl-hp-fill" class="hp-fill" style="background:var(--success);"></div>
                <div id="ui-pl-shield-fill" class="shield-fill"></div>
            </div>
        </div>
        
        <div id="action-log"></div>
    </div>

    <div id="action-area">
        <div id="piles-ui">
            <div class="pile-btn" onclick="showPile('DRAW PILE', state.drawPile)">
                <span class="pile-lbl">DRAW</span><span id="ui-draw-n" class="pile-num">0</span>
            </div>
            <div class="pile-btn" onclick="showPile('DISCARD', state.discardPile)">
                <span class="pile-lbl">DISC</span><span id="ui-disc-n" class="pile-num">0</span>
            </div>
        </div>

        <div id="hand-container"></div>

        <div id="controls-ui">
            <div id="hand-counter">0/5</div>
            <button id="end-btn">END</button>
        </div>
    </div>

    <div id="overlay-screen" class="overlay" onclick="closeOverlay(event)">
        <div class="victory-title" id="overlay-title">TITLE</div>
        <div id="viewer-grid"></div>
        <div id="reward-container" class="reward-container"></div>
        <div style="color:#888; margin-top:20px; font-size:0.8rem;" id="overlay-tip">(Click background to close)</div>
    </div>

    <script>
        const BASE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRuNEG1oT6a0JsP4Zy8uqFSRDKaxEM8FJetpMWOZ0vR6yg4AGqGtMlLJ_0NSxIE_tqSnOsPd9aLWtg8/pub?output=csv";
        const GID_CARD = "0"; const GID_ENEMY = "322780304"; const GID_CONFIG = "1319509950";

        let state = {
            pHP: 100, pMaxHP: 100, pShd: 0, pStr: 0, pMarks: [],
            eng: 3, maxEng: 3, maxHand: 5, round: 1,
            lib: [], deck: [], draw: [], disc: [], hand: [],
            enPool: [], waves: [], curWave: [], curEn: null, wIdx: 0,
            sel: null, mode: 'battle' // battle, reward, view
        };

        // --- Init ---
        async function init() {
            Papa.parse(`${BASE_URL}&gid=${GID_CARD}`, { download: true, header: false, complete: (r) => {
                state.lib = r.data.slice(1).filter(d=>d[0]).map((d,i)=>({name:d[0], eff:d[1], cost:parseInt(d[2])||0, id:i+2}));
                state.deck = [];
                state.lib.slice(0,5).forEach(c=>{ state.deck.push({...c}); state.deck.push({...c}); });
                initBattle();
            }});
            Papa.parse(`${BASE_URL}&gid=${GID_ENEMY}`, { download: true, header: false, complete: (r) => {
                state.enPool = r.data.slice(1).filter(d=>d[0]).map((d,i)=>({name:d[0], hp:parseInt(d[1])||10, type:parseInt(d[2])||1, acts:[d[4],d[5],d[6],d[7],d[8],d[9]].filter(a=>a&&a.trim())}));
                Papa.parse(`${BASE_URL}&gid=${GID_CONFIG}`, { download: true, header: false, complete: (r) => {
                    state.waves = r.data.slice(1).map(d=>({n:parseInt(d[0])||0, e:parseInt(d[1])||0, b:parseInt(d[2])||0, z:parseInt(d[3])||0}));
                    genWave();
                }});
            }});
        }

        function initBattle() {
            state.draw = [...state.deck]; state.disc = []; state.hand = [];
            shuffle(state.draw); drawCard(5);
        }
        function shuffle(a) { for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} }

        // --- Core Logic ---
        function genWave() {
            const cfg = state.waves[state.round-1];
            if(!cfg) return alert("VICTORY!");
            let w = [];
            const add = (t,n) => { const p=state.enPool.filter(e=>e.type===t); for(let i=0;i<n;i++) if(p.length) w.push({...p[Math.floor(Math.random()*p.length)]}); };
            add(1,cfg.n); add(2,cfg.e); add(3,cfg.b); add(4,cfg.z);
            state.curWave = w; state.wIdx = 0; nextEn();
        }

        function nextEn() {
            document.body.classList.remove('boss-mode');
            if(state.wIdx >= state.curWave.length) return showReward();
            const raw = state.curWave[state.wIdx];
            state.curEn = { ...raw, curHP: raw.hp, step:0, psn:0, vuln:0, weak:0, stun:false, marks:[] };
            state.wIdx++;
            if(state.curEn.type===4) { document.body.classList.add('boss-mode'); log("BOSS WARNING"); }
            document.getElementById('enemy-target').className = 'enemy-box tier-'+state.curEn.type;
            update();
        }

        function drawCard(n) {
            const can = state.maxHand - state.hand.length;
            let cnt = Math.min(n, can);
            if(cnt<=0 && n>0) log("HAND FULL");
            for(let i=0; i<cnt; i++) {
                if(!state.draw.length) {
                    if(!state.disc.length) break;
                    state.draw=[...state.disc]; state.disc=[]; shuffle(state.draw); log("SHUFFLE");
                }
                state.hand.push(state.draw.pop());
            }
            renderHand(); update();
        }

        function playCard(c, idx) {
            state.eng -= c.cost;
            
            // Ëß£ÊûêÊïàÊûú
            const reg = /\[#(\w+)\s*(.*?)\]/g; let m;
            while((m=reg.exec(c.eff))!==null) {
                const t=m[1], vRaw=m[2], val=calc(vRaw);
                if(t==='dmg') dmgEn(val);
                if(t==='def') { state.pShd+=val; log(`SHIELD ${val}`); }
                if(t==='heal') { state.pHP=Math.min(state.pMaxHP, state.pHP+val); log(`HEAL ${val}`); }
                if(t==='eng') { state.eng+=val; log(`ENG +${val}`); }
                if(t==='draw') { drawCard(val); log(`DRAW ${val}`); }
                if(t==='hand_limit') { state.maxHand=Math.max(0,state.maxHand+val); log(`HAND MAX ${val>0?'+':''}${val}`); }
                if(t==='mark') { const n=vRaw.trim(); if(state.sel.target==='en'){ state.curEn.marks.push(n); }else{ state.pMarks.push(n); } log(`MARK: ${n}`); }
                if(t==='unmark') { const n=vRaw.trim(); const arr=state.sel.target==='en'?state.curEn.marks:state.pMarks; const i=arr.indexOf(n); if(i>-1) arr.splice(i,1); }
                if(t==='psn') { state.curEn.psn+=val; log(`POISON ${val}`); }
                if(t==='vuln') { state.curEn.vuln+=val; log(`VULN ${val}`); }
                if(t==='weak') { state.curEn.weak+=val; log(`WEAK ${val}`); }
                if(t==='stun') { state.curEn.stun=true; log("STUNNED"); }
                if(t==='sdmg') { state.pHP-=val; log(`HURT ${val}`); }
                if(t==='str') { state.pStr+=val; log(`STR ${val}`); }
                if(t==='drain') { const d=dmgEn(val); state.pHP=Math.min(state.pMaxHP, state.pHP+d); log(`DRAIN ${d}`); }
                if(t==='pure') { state.curEn.curHP-=val; log(`PURE ${val}`); visualFlash('enemy-target','pure'); }
                if(t==='maxhp') { state.pMaxHP+=val; state.pHP+=val; log(`MAXHP +${val}`); }
            }

            state.hand.splice(idx, 1);
            if(c.eff.includes('[#once]')) log("BANISHED");
            else state.disc.push(c);
            
            cancelSel(); checkWin(); update(); renderHand();
        }

        function calc(s) {
            if(!s || !s.trim()) return 1; if(!isNaN(s)) return parseFloat(s);
            const e=state.curEn; const h=state.hand.length; 
            let x = s.toLowerCase()
                .replace(/{hp}/g,state.pHP).replace(/{mhp}/g,state.pMaxHP).replace(/{shd}/g,state.pShd)
                .replace(/{str}/g,state.pStr).replace(/{eng}/g,state.eng).replace(/{hand}/g,h)
                .replace(/{draw_pile}/g,state.draw.length).replace(/{disc_pile}/g,state.disc.length)
                .replace(/{en_hp}/g,e?e.curHP:0).replace(/{en_mhp}/g,e?e.hp:0)
                .replace(/{en_psn}/g,e?e.psn:0).replace(/{en_vuln}/g,e?e.vuln:0);
            try { return Math.floor(new Function('return '+x)()); } catch{ return 0; }
        }

        function dmgEn(v) {
            let d = v + state.pStr; if(state.curEn.vuln>0) d=Math.floor(d*1.5);
            state.curEn.curHP-=d; log(`HIT ${d}`); visualFlash('enemy-target','dmg'); return d;
        }

        function checkWin() { if(state.curEn && state.curEn.curHP<=0) nextEn(); }

        // --- Interaction ---
        function renderHand() {
            const div = document.getElementById('hand-container'); div.innerHTML='';
            state.hand.forEach((c, i) => {
                const el = document.createElement('div'); el.className='card';
                el.innerHTML = `
                    <div class="card-header"><div class="card-cost">${c.cost}</div><div class="card-id">#${c.id}</div></div>
                    <div class="card-name">${c.name}</div>
                    <div class="card-body">${fmt(c.eff)}</div>
                `;
                // ÈªûÊìä‰∫ã‰ª∂
                el.onclick = (e) => {
                    e.stopPropagation();
                    if(state.eng < c.cost) { log("NO ENERGY"); return; }
                    
                    // Ê¢ù‰ª∂Ê™¢Êü• (Req)
                    const req = /\[#req\s+(.*?)\]/.exec(c.eff);
                    if(req && !state.curEn.marks.includes(req[1].trim())) { log(`REQ: ${req[1]}`); return; }
                    const reqm = /\[#reqme\s+(.*?)\]/.exec(c.eff);
                    if(reqm && !state.pMarks.includes(reqm[1].trim())) { log(`NEED: ${reqm[1]}`); return; }

                    if(state.sel && state.sel.idx === i) cancelSel();
                    else {
                        cancelSel();
                        state.sel = { idx:i, card:c };
                        el.classList.add('selected');
                        // Ëá™ÂãïÂà§Êñ∑ÁõÆÊ®ô
                        const isAtk = /\[#(dmg|psn|weak|vuln|stun|drain|pure|mark|unmark|req)/.test(c.eff);
                        if(isAtk) { document.getElementById('enemy-target').classList.add('target-active'); state.sel.target='en'; }
                        else { document.getElementById('player-box').classList.add('target-active'); state.sel.target='pl'; }
                    }
                };
                // ËßíÂ∫¶
                const rot = (i - (state.hand.length-1)/2) * 5;
                el.style.transform = `rotate(${rot}deg) translateY(${Math.abs(rot)*2}px)`;
                
                div.appendChild(el);
            });
        }

        function cancelSel() {
            state.sel = null;
            document.querySelectorAll('.selected').forEach(e=>e.classList.remove('selected'));
            document.querySelectorAll('.target-active').forEach(e=>e.classList.remove('target-active'));
        }

        document.getElementById('enemy-target').onclick = () => { if(state.sel && state.sel.target==='en') playCard(state.sel.card, state.sel.idx); };
        document.getElementById('player-box').onclick = () => { if(state.sel && state.sel.target==='pl') playCard(state.sel.card, state.sel.idx); };

        document.getElementById('end-btn').onclick = () => {
            if(!state.curEn) return;
            // Ê£ÑÊâãÁâå
            state.hand.forEach(c=>state.disc.push(c)); state.hand=[];
            renderHand();
            
            // Êïµ‰∫∫ÂõûÂêà
            if(state.curEn.psn>0) { 
                state.curEn.curHP-=state.curEn.psn; state.curEn.psn--; log(`POISON ${state.curEn.psn+1}`);
                if(state.curEn.curHP<=0) { nextEn(); newTurn(); return; }
            }
            
            if(state.curEn.stun) { log("ENEMY STUNNED"); state.curEn.stun=false; }
            else {
                const act = state.curEn.acts[(state.curEn.step++) % state.curEn.acts.length];
                const reg = /\[#(\w+)\s*(.*?)\]/g; let m;
                while((m=reg.exec(act))!==null) {
                    const t=m[1], v=calc(m[2]);
                    if(t==='dmg') {
                        let inc = v; if(state.curEn.weak>0) inc=Math.floor(inc*0.75);
                        let rem = inc;
                        if(state.pShd>=rem) { state.pShd-=rem; rem=0; log("BLOCKED"); }
                        else { rem-=state.pShd; state.pShd=0; }
                        if(rem>0) { state.pHP-=rem; log(`TOOK ${rem}`); visualFlash('player-box','dmg'); }
                    }
                    if(t==='heal') { state.curEn.curHP+=v; log(`EN HEAL ${v}`); }
                    if(t==='mark') { state.pMarks.push(m[2].trim()); log(`MARKED: ${m[2]}`); }
                }
            }
            
            if(state.curEn.vuln>0) state.curEn.vuln--;
            if(state.curEn.weak>0) state.curEn.weak--;
            
            newTurn();
        };

        function newTurn() {
            state.pShd=0; state.eng=state.maxEng; drawCard(5); update();
        }

        // --- UI Utils ---
        function update() {
            // Stats
            document.getElementById('ui-eng').innerText = `${state.eng}/${state.maxEng}`;
            document.getElementById('ui-wave').innerText = state.curWave.length - state.wIdx;
            document.getElementById('ui-round').innerText = state.round;
            document.getElementById('hand-counter').innerText = `${state.hand.length}/${state.maxHand}`;
            document.getElementById('ui-draw-n').innerText = state.draw.length;
            document.getElementById('ui-disc-n').innerText = state.disc.length;

            // Player
            document.getElementById('ui-pl-hp-text').innerText = `${state.pHP}/${state.pMaxHP}`;
            document.getElementById('ui-pl-hp-fill').style.width = Math.max(0, (state.pHP/state.pMaxHP)*100)+'%';
            document.getElementById('ui-pl-shield-fill').style.width = state.pShd>0 ? Math.min(100,(state.pShd/state.pMaxHP)*100)+'%' : '0%';
            const pb = document.getElementById('pl-status'); pb.innerHTML='';
            if(state.pShd>0) pb.innerHTML+=`<span class="status-icon st-shield">${state.pShd}</span>`;
            if(state.pStr>0) pb.innerHTML+=`<span class="status-icon st-str">${state.pStr}</span>`;
            countMarks(state.pMarks).forEach(m=> pb.innerHTML+=`<span class="status-text">${m.n}${m.c>1?' x'+m.c:''}</span>`);

            // Enemy
            if(state.curEn) {
                const e = state.curEn;
                document.getElementById('ui-en-name').innerText = e.name;
                document.getElementById('ui-en-hp-text').innerText = `${e.curHP}/${e.hp}`;
                document.getElementById('ui-en-hp-fill').style.width = Math.max(0, (e.curHP/e.hp)*100)+'%';
                
                const act = e.acts[e.step % e.acts.length];
                document.getElementById('ui-en-intent').innerText = `INTENT: ${act}`;

                const eb = document.getElementById('en-status'); eb.innerHTML='';
                if(e.psn>0) eb.innerHTML+=`<span class="status-icon st-poison">${e.psn}</span>`;
                if(e.vuln>0) eb.innerHTML+=`<span class="status-icon st-vuln">${e.vuln}</span>`;
                if(e.weak>0) eb.innerHTML+=`<span class="status-icon st-weak">${e.weak}</span>`;
                if(e.stun) eb.innerHTML+=`<span class="status-icon st-stun">STUN</span>`;
                countMarks(e.marks).forEach(m=> eb.innerHTML+=`<span class="status-text">${m.n}${m.c>1?' x'+m.c:''}</span>`);
            }
            if(state.pHP<=0) { setTimeout(()=>location.reload(), 500); alert("DEFEAT"); }
        }

        function showReward() {
            state.mode = 'reward';
            const ov = document.getElementById('overlay-screen');
            const rc = document.getElementById('reward-container');
            const vg = document.getElementById('viewer-grid');
            
            document.getElementById('overlay-title').innerText = "WAVE CLEARED";
            document.getElementById('overlay-tip').style.display = 'none';
            vg.innerHTML = ''; rc.innerHTML = ''; ov.style.display = 'flex';

            // Rewards
            const r1 = `<div class="reward-card" onclick="rewardRemove()"><div class="reward-icon">üî•</div><div>PURGE<br><span style="font-size:0.7rem;color:#888">Remove a card</span></div></div>`;
            const r2 = `<div class="reward-card" onclick="rewardAdd()"><div class="reward-icon">üÉè</div><div>DRAFT<br><span style="font-size:0.7rem;color:#888">Add a card</span></div></div>`;
            const r3 = `<div class="reward-card" onclick="rewardHeal()"><div class="reward-icon">‚ù§</div><div>REST<br><span style="font-size:0.7rem;color:#888">Heal 15%</span></div></div>`;
            rc.innerHTML = r1+r2+r3;
        }

        window.rewardHeal = () => {
            state.pHP = Math.min(state.pMaxHP, state.pHP + Math.floor(state.pMaxHP*0.15));
            nextLevel();
        };
        window.rewardRemove = () => {
            const rc = document.getElementById('reward-container'); rc.innerHTML = '';
            const vg = document.getElementById('viewer-grid');
            state.deck.forEach((c,i)=>{
                const el = mkCardEl(c); el.onclick = ()=>{ if(confirm("Remove?")) { state.deck.splice(i,1); nextLevel(); }};
                vg.appendChild(el);
            });
        };
        window.rewardAdd = () => {
            const rc = document.getElementById('reward-container'); rc.innerHTML = '';
            const vg = document.getElementById('viewer-grid');
            for(let i=0;i<3;i++){
                const c = state.lib[Math.floor(Math.random()*state.lib.length)];
                const el = mkCardEl(c); el.onclick = ()=>{ if(confirm("Add?")) { state.deck.push({...c}); nextLevel(); }};
                vg.appendChild(el);
            }
        };

        function nextLevel() {
            document.getElementById('overlay-screen').style.display='none';
            state.round++; state.mode='battle'; genWave(); initBattle();
        }

        function showPile(t, arr) {
            if(state.mode==='reward') return;
            const ov = document.getElementById('overlay-screen');
            const rc = document.getElementById('reward-container');
            const vg = document.getElementById('viewer-grid');
            document.getElementById('overlay-title').innerText = t;
            document.getElementById('overlay-tip').style.display = 'block';
            rc.innerHTML = ''; vg.innerHTML = '';
            [...arr].sort((a,b)=>a.id-b.id).forEach(c => vg.appendChild(mkCardEl(c)));
            ov.style.display = 'flex'; state.mode='view';
        }

        function closeOverlay(e) {
            if(state.mode==='view' && e.target.id==='overlay-screen') {
                document.getElementById('overlay-screen').style.display='none'; state.mode='battle';
            }
        }

        function mkCardEl(c) {
            const el = document.createElement('div'); el.className='card';
            el.innerHTML=`<div class="card-header"><div class="card-cost">${c.cost}</div><div class="card-id">#${c.id}</div></div><div class="card-name">${c.name}</div><div class="card-body">${fmt(c.eff)}</div>`;
            el.style.position='relative'; el.style.margin='0'; el.style.transform='none';
            return el;
        }

        function fmt(t) {
            return t.replace(/\[#(\w+)\s*(.*?)\]/g, (m,k,v)=>{
                if(k==='dmg') return `<span class="tag bg-dmg">DMG ${v}</span>`;
                if(k==='def') return `<span class="tag bg-def">DEF ${v}</span>`;
                if(k==='heal') return `<span class="tag bg-heal">HEAL ${v}</span>`;
                if(k==='mark') return `<span class="tag bg-mark">${v}</span>`;
                if(k==='req') return `<span class="tag bg-req">REQ ${v}</span>`;
                if(k==='once') return `<span class="tag bg-once">ONCE</span>`;
                return `<span class="tag bg-misc">${k.toUpperCase()} ${v}</span>`;
            });
        }

        function log(m) { const l=document.getElementById('action-log'); l.innerText=m; l.style.opacity=1; l.style.transform="translateY(-20px)"; setTimeout(()=>{l.style.opacity=0;l.style.transform="translateY(0)"},800); }
        function visualFlash(id,t) { const e=document.getElementById(id); if(t==='dmg')e.style.filter="sepia(1) hue-rotate(-50deg) saturate(5)"; if(t==='pure')e.style.filter="invert(1)"; setTimeout(()=>e.style.filter="",100); }
        function countMarks(m){ const c={}; m.forEach(x=>{c[x]=(c[x]||0)+1}); return Object.entries(c).map(([n,c])=>({n,c})); }
        
        document.body.onclick = () => { if(state.sel) cancelSel(); };
    </script>
</body>
</html>
