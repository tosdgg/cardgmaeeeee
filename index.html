<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Steampunk Duelist v5.3 - Critical Logic Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Rye&display=swap" rel="stylesheet">
    <style>
        :root {
            --brass: #b5a642; --bronze: #cd7f32; --gold: #ffd700;
            --leather: #4a3c31; --parchment: #eaddcf; --steam-blue: #00f3ff;
            --danger: #ff4444; --success: #44ff44;
        }
        body { margin: 0; background: #120f0d; color: var(--parchment); font-family: 'IM Fell English SC', serif; overflow: hidden; height: 100vh; }
        #battle-stage { position: absolute; top: 50px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 40px; }
        .round-gauge { width: 80px; height: 100px; background: var(--leather); border: 3px double var(--brass); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* 敵人方塊與邊框 */
        .enemy-box { width: 420px; background: #222; border: 6px ridge #888; padding: 25px; border-radius: 5px; position: relative; transition: 0.3s; }
        .tier-1 { border-color: #cd7f32 !important; }
        .tier-2 { border-color: #c0c0c0 !important; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .tier-3 { border-color: #ffd700 !important; box-shadow: 0 0 35px rgba(255,215,0,0.4); }

        .hp-container { width: 100%; height: 22px; background: #000; border-radius: 11px; border: 2px solid var(--brass); overflow: hidden; margin: 10px 0; }
        .hp-fill { height: 100%; transition: 0.4s; }
        #player-hub { position: absolute; bottom: 320px; left: 50%; transform: translateX(-50%); width: 450px; padding: 10px; }
        #end-btn { position: absolute; right: 40px; top: 50%; transform: translateY(-50%); width: 110px; height: 110px; border-radius: 50%; background: var(--bronze); border: 6px double var(--brass); color: #fff; font-family: 'Rye'; cursor: pointer; }
        #hand-area { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; height: 260px; display: flex; justify-content: center; align-items: flex-end; }
        .card { width: 160px; height: 230px; background: var(--parchment); color: #2a1a0a; border: 5px solid var(--bronze); border-radius: 12px; margin: 0 -5px; cursor: pointer; position: relative; transition: 0.2s; }
        .card.selected { transform: translateY(-50px); border-color: var(--steam-blue); }
        .card-cost { position: absolute; top: -10px; left: -10px; width: 35px; height: 35px; background: #222; color: var(--steam-blue); border: 2px solid var(--steam-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Rye'; }
    </style>
</head>
<body>

    <div id="battle-stage">
        <div class="round-gauge"><span>ROUND</span><span id="ui-round" style="font-family:'Rye'; font-size:2rem;">1</span></div>
        <div class="enemy-box" id="enemy-target">
            <div id="ui-en-name" style="font-family:'Rye'; font-size:1.8rem;">LOADING...</div>
            <div class="hp-container"><div id="ui-en-hp-fill" class="hp-fill" style="background: var(--danger); width: 100%;"></div></div>
            <div id="ui-en-hp-text" style="text-align:right;">-- / --</div>
        </div>
    </div>

    <div id="player-hub">
        <div style="display:flex; justify-content:space-between;"><span>PLAYER_CORE</span><span id="ui-pl-hp">100 / 100</span></div>
        <div class="hp-container"><div id="ui-pl-hp-fill" class="hp-fill" style="background: var(--success); width: 100%;"></div></div>
    </div>

    <button id="end-btn">END<br>ACTION</button>
    <div id="hand-area"></div>

    <script>
        const BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRuNEG1oT6a0JsP4Zy8uqFSRDKaxEM8FJetpMWOZ0vR6yg4AGqGtMlLJ_0NSxIE_tqSnOsPd9aLWtg8/pub?output=csv";
        let state = { playerHP: 100, energy: 3, round: 1, cardPool: [], enemyPool: [], configPool: [], currentWave: [], curEnemy: null, waveIdx: 0, selectedCard: null };

        async function init() {
            // 讀取卡牌
            Papa.parse(`${BASE}&gid=0`, { download: true, header: true, complete: res => {
                state.cardPool = res.data.map(r => ({ name: r.Name || Object.values(r)[0], effect: r.Effect || Object.values(r)[1], cost: parseInt(r.Cost || Object.values(r)[2]) || 0 }));
                draw(5);
            }});

            // 讀取敵人 (E-J 欄是索引 4,5,6,7,8,9)
            Papa.parse(`${BASE}&gid=322780304`, { download: true, header: true, complete: res => {
                state.enemyPool = res.data.filter(r => Object.values(r)[0]).map(r => {
                    const v = Object.values(r);
                    return { name: v[0], hp: parseInt(v[1])||10, type: parseInt(v[2])||1, actions: [v[4],v[5],v[6],v[7],v[8],v[9]].filter(a => a && a.trim()!=='') };
                });
                // 讀取配置
                Papa.parse(`${BASE}&gid=1319509950`, { download: true, header: true, complete: res => {
                    state.configPool = res.data.map(r => {
                        const v = Object.values(r);
                        return { n: parseInt(v[0])||0, e: parseInt(v[1])||0, b: parseInt(v[2])||0 };
                    });
                    generateWave();
                }});
            }});
        }

        function generateWave() {
            const cfg = state.configPool[state.round - 1];
            if(!cfg) return alert("Finished");
            let wave = [];
            const add = (t, c) => {
                const pool = state.enemyPool.filter(e => e.type === t);
                for(let i=0; i<c; i++) if(pool.length) wave.push({...pool[Math.floor(Math.random()*pool.length)]});
            };
            add(1, cfg.n); add(2, cfg.e); add(3, cfg.b);
            state.currentWave = wave; state.waveIdx = 0;
            spawn();
        }

        function spawn() {
            if(state.waveIdx < state.currentWave.length) {
                const data = state.currentWave[state.waveIdx];
                state.curEnemy = { ...data, curHP: data.hp, step: 0 };
                state.waveIdx++;
                document.getElementById('enemy-target').className = `enemy-box tier-${state.curEnemy.type}`;
                updateUI();
            } else {
                state.round++; generateWave();
            }
        }

        function draw(n) {
            const area = document.getElementById('hand-area'); area.innerHTML = '';
            for(let i=0; i<n; i++) {
                const d = state.cardPool[Math.floor(Math.random()*state.cardPool.length)];
                const el = document.createElement('div'); el.className = 'card';
                el.innerHTML = `<div class="card-cost">${d.cost}</div><div style="padding:10px;text-align:center;">${d.name}</div>`;
                el.onclick = () => { if(state.energy >= d.cost) { state.selectedCard = {el, d}; document.querySelectorAll('.card').forEach(c=>c.classList.remove('selected')); el.classList.add('selected'); }};
                area.appendChild(el);
            }
        }

        document.getElementById('enemy-target').onclick = () => {
            if(!state.selectedCard) return;
            const d = state.selectedCard.d; state.energy -= d.cost;
            const reg = /\[#(\w+)\s+(-?\d+)\]/g; let m;
            while((m = reg.exec(d.effect)) !== null) if(m[1] === 'dmg') state.curEnemy.curHP -= parseInt(m[2]);
            state.selectedCard.el.remove(); state.selectedCard = null;
            if(state.curEnemy.curHP <= 0) spawn();
            updateUI();
        };

        // 敵人攻擊核心：確保能解析標籤
        function enemyTurn() {
            if(!state.curEnemy) return;
            const acts = state.curEnemy.actions;
            if(!acts || acts.length === 0) return;
            const currentAct = acts[state.curEnemy.step % acts.length];
            const reg = /\[#(\w+)\s+(-?\d+)\]/g; let m;
            while((m = reg.exec(currentAct)) !== null) {
                if(m[1] === 'dmg') state.playerHP -= parseInt(m[2]);
            }
            state.curEnemy.step++;
        }

        document.getElementById('end-btn').onclick = () => {
            enemyTurn();
            state.energy = 3; draw(5); updateUI();
        };

        function updateUI() {
            if(state.curEnemy) {
                document.getElementById('ui-en-name').innerText = state.curEnemy.name;
                document.getElementById('ui-en-hp-fill').style.width = (state.curEnemy.curHP/state.curEnemy.hp*100)+'%';
                document.getElementById('ui-en-hp-text').innerText = `${state.curEnemy.curHP} / ${state.curEnemy.hp}`;
            }
            document.getElementById('ui-round').innerText = state.round;
            document.getElementById('ui-pl-hp').innerText = `${state.playerHP} / 100`;
            document.getElementById('ui-pl-hp-fill').style.width = state.playerHP + '%';
            if(state.playerHP <= 0) { alert("Game Over"); location.reload(); }
        }
        window.onload = init;
    </script>
</body>
</html>
