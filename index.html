<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Steampunk Duelist v9.2 - Rewards</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Rye&display=swap" rel="stylesheet">
    <style>
        :root {
            --brass: #b5a642; --bronze: #cd7f32; --gold: #ffd700;
            --leather: #4a3c31; --parchment: #eaddcf; --steam-blue: #00f3ff;
            --danger: #ff4444; --success: #44ff44; --shield: #00aaff; --poison: #bf00ff;
            --str: #ff9900; --vuln: #ff0055; --weak: #88cc00;
            --boss-purple: #b300ff; --boss-red-bg: #3a0000;
        }

        body {
            margin: 0; padding: 0; background: #120f0d;
            color: var(--parchment); font-family: 'IM Fell English SC', serif;
            overflow: hidden; height: 100vh; user-select: none;
            background-image: radial-gradient(circle, #2a221b 0%, #120f0d 100%);
            transition: background-image 1.5s ease-in-out; touch-action: manipulation;
        }

        body.boss-mode { background-image: radial-gradient(circle, #7a0000 0%, var(--boss-red-bg) 100%) !important; }

        /* Ë∑ëÈ¶¨Ááà */
        #marquee-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 35px;
            background: var(--danger); border-bottom: 3px double var(--gold);
            color: #fff; overflow: hidden; z-index: 9999;
            display: none; box-shadow: 0 0 20px var(--danger);
        }
        body.boss-mode #marquee-container { display: block; }
        .marquee-content { display: flex; width: fit-content; animation: marquee-scroll 10s linear infinite; }
        .marquee-content span { white-space: nowrap; font-family: 'Rye', cursive; font-size: 1.3rem; line-height: 35px; padding-right: 50px; text-shadow: 2px 2px 4px #000; }
        @keyframes marquee-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

        /* --- ÈÅéÂ†¥Áï´Èù¢ËàáÁçéÂãµ UI (Â§ßÂπÖÊõ¥Êñ∞) --- */
        #victory-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 10000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(8px);
        }
        .victory-title { font-family: 'Rye'; font-size: 3.5rem; color: var(--gold); text-shadow: 0 0 20px var(--brass); margin-bottom: 20px; }
        .victory-subtitle { font-size: 1rem; color: #888; margin-bottom: 30px; letter-spacing: 2px; }
        
        /* ÁçéÂãµÊåâÈàïÂÆπÂô® */
        #reward-options { display: flex; gap: 30px; margin-bottom: 20px; }
        
        .reward-btn {
            width: 220px; height: 280px;
            background: #222; border: 4px double var(--bronze); border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; padding: 15px; text-align: center;
            color: var(--parchment); position: relative; overflow: hidden;
        }
        .reward-btn:hover { transform: translateY(-10px); border-color: var(--steam-blue); box-shadow: 0 0 20px var(--steam-blue); background: #2a2a2a; }
        .reward-icon { font-size: 4rem; margin-bottom: 20px; }
        .reward-name { font-family: 'Rye'; font-size: 1.5rem; margin-bottom: 10px; color: var(--gold); }
        .reward-desc { font-size: 0.9rem; color: #aaa; }

        /* Ë≠¶ÂëäÊñáÂ≠ó */
        .warning-text { color: var(--danger); font-size: 0.9rem; margin-top: 20px; border: 1px solid var(--danger); padding: 5px 15px; border-radius: 5px; background: rgba(255, 0, 0, 0.1); }

        /* Âç°ÁâåÈÅ∏ÊìáÂçÄÂüü (Èö±ËóèÂ±§) */
        #card-selection-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: none;
            flex-direction: column; align-items: center; justify-content: center; z-index: 10001;
        }
        #selection-grid { 
            display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; 
            max-width: 90%; max-height: 70vh; overflow-y: auto; padding: 20px;
        }
        .selection-title { font-family: 'Rye'; font-size: 2rem; color: #fff; margin-bottom: 20px; }

        /* ‰∏ã‰∏ÄÈóúÊåâÈàï */
        #next-lvl-btn {
            padding: 15px 50px; font-size: 2rem; font-family: 'Rye';
            background: var(--steam-blue); color: #000; border: 5px solid #fff;
            border-radius: 10px; cursor: pointer; box-shadow: 0 0 30px var(--steam-blue);
            animation: pulse-btn 1s infinite alternate; display: none; margin-top: 30px;
        }
        @keyframes pulse-btn { from { transform: scale(1); } to { transform: scale(1.05); } }

        /* --- Êà∞È¨•Ëàá UI --- */
        #battle-stage { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 40px; transition: 0.3s; z-index: 5; }
        .round-gauge { width: 80px; height: 100px; background: var(--leather); border: 3px double var(--brass); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .enemy-box { width: 420px; background: #222; border: 6px ridge var(--bronze); padding: 25px; border-radius: 5px; position: relative; cursor: pointer; transition: 0.3s; }
        .enemy-box.stunned { filter: grayscale(100%) brightness(0.7); border-color: #555 !important; }
        .tier-1 { border-color: #cd7f32 !important; } .tier-2 { border-color: #c0c0c0 !important; box-shadow: 0 0 20px rgba(192,192,192,0.3); } .tier-3 { border-color: #ffd700 !important; box-shadow: 0 0 35px rgba(255,215,0,0.5); }
        .tier-4 { border-color: var(--boss-purple) !important; box-shadow: 0 0 40px var(--boss-purple), inset 0 0 15px var(--boss-purple); animation: boss-pulse 1.5s infinite alternate ease-in-out; }
        @keyframes boss-pulse { from { box-shadow: 0 0 30px var(--boss-purple), inset 0 0 10px var(--boss-purple); } to { box-shadow: 0 0 60px var(--boss-purple), inset 0 0 25px var(--boss-purple); filter: brightness(1.1); } }
        
        .target-active { outline: 3px solid var(--steam-blue); box-shadow: 0 0 30px var(--steam-blue); }
        .status-bar { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; height: 24px; }
        .status-icon, .status-text { display: inline-flex; align-items: center; justify-content: center; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-family: sans-serif; font-size: 0.8rem; box-shadow: 1px 1px 2px #000; color: #fff; border: 1px solid rgba(255,255,255,0.3); margin-right: 2px;}
        .status-text { background: #444; font-family: 'IM Fell English SC', serif; }
        .st-poison { background: var(--poison); } .st-shield { background: var(--shield); } .st-str { background: var(--str); } .st-vuln { background: var(--vuln); } .st-weak { background: var(--weak); color: #000; } .st-stun { background: #555; border: 1px dashed #fff; }
        .marker-lockon { background: #ff0055; border-color: #ffaaaa; } .marker-stance { background: #00aaff; border-color: #aaffff; }

        #side-panel { position: absolute; left: 30px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 20px; transition: 0.3s; z-index: 10; }
        .gauge-circle { width: 100px; height: 100px; border: 4px solid var(--brass); border-radius: 50%; background: radial-gradient(circle, var(--leather), #111); display: flex; flex-direction: column; align-items: center; justify-content: center; }

        #pile-display { position: absolute; bottom: 20px; left: 20px; display: flex; gap: 15px; z-index: 50; }
        .pile-box { width: 60px; height: 80px; background: #222; border: 2px solid var(--brass); display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 5px; box-shadow: 0 5px 10px #000; }
        .pile-label { font-size: 0.6rem; color: #888; margin-bottom: 5px; } .pile-count { font-family: 'Rye'; font-size: 1.5rem; color: #fff; }

        #hand-area { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; height: 260px; display: flex; justify-content: center; align-items: flex-end; perspective: 1000px; pointer-events: none; transition: 0.3s; z-index: 20; }
        .card { width: 160px; height: 230px; background: var(--parchment); color: #2a1a0a; border: 5px solid var(--bronze); border-radius: 12px; margin: 0 -15px; cursor: pointer; position: relative; transition: 0.25s; background-image: url('https://www.transparenttextures.com/patterns/pinstriped-suit.png'); pointer-events: auto; box-shadow: -5px 5px 15px rgba(0,0,0,0.5); flex-shrink: 0; }
        .card:hover { transform: translateY(-40px) rotate(0deg) !important; z-index: 100; margin: 0 5px; }
        .card.selected { transform: translateY(-80px) scale(1.1) !important; border-color: var(--steam-blue); box-shadow: 0 0 30px var(--steam-blue); z-index: 200; }
        .card-cost { position: absolute; top: -15px; left: -15px; width: 40px; height: 40px; background: #222; color: var(--steam-blue); border: 2px solid var(--steam-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Rye'; font-size: 1.4rem; z-index: 2; }
        .card-name { padding:15px 5px; text-align:center; font-family:'Rye'; font-size:1.0rem; border-bottom:2px solid #aaa; line-height: 1.1; font-weight: bold; }
        .card-desc { margin-top: 20px; text-align: center; font-size: 0.85rem; color: #421; padding: 0 10px; line-height: 1.3; font-weight: bold;}
        .tag-badge { display: inline-block; padding: 1px 3px; border-radius: 3px; font-size: 0.75rem; margin: 1px; color: #fff; text-shadow: 1px 1px 0 #000; }
        .bg-dmg { background: #aa4444; } .bg-def { background: #0088cc; } .bg-heal { background: #44aa44; } .bg-psn { background: #8800cc; } .bg-eng { background: #ccaa00; } .bg-draw { background: #555; } .bg-sdmg { background: #550000; border: 1px dashed #f00; } .bg-str { background: #ff9900; } .bg-weak { background: #88cc00; color: #000; text-shadow: none; } .bg-vuln { background: #ff0055; } .bg-stun { background: #333; border: 1px double #fff; } .bg-drain { background: #aa0044; } .bg-pure { background: #fff; color: #000; text-shadow: none; border: 1px solid #000; } .bg-maxhp { background: #228822; border: 1px solid #aaffaa; } .bg-mark { background: #444; border: 1px solid #fff; } .bg-req { background: #000; color: #f00; border: 1px solid #f00; } .bg-once { background: #333; color: #aaa; border: 1px solid #aaa; }

        .hp-container { width: 100%; height: 22px; background: #000; border-radius: 11px; border: 2px solid var(--brass); overflow: hidden; margin: 10px 0; position: relative; }
        .hp-fill { height: 100%; width: 100%; transition: 0.4s; position: absolute; left: 0; top: 0; }
        .shield-fill { height: 100%; width: 0%; background: var(--shield); opacity: 0.6; position: absolute; left: 0; top: 0; transition: 0.4s; z-index: 2;}

        #player-hub { position: absolute; bottom: 320px; left: 50%; transform: translateX(-50%); width: 450px; cursor: pointer; padding: 10px; border-radius: 10px; transition: 0.2s; z-index: 10; }
        #action-log { position: absolute; top: 120px; width: 100%; text-align: center; color: #fff; font-family: 'Rye'; text-shadow: 0 0 5px #000; pointer-events: none; z-index: 500; font-size: 1.5rem; transition: 0.3s; }
        #end-btn { position: absolute; right: 40px; top: 50%; transform: translateY(-50%); width: 110px; height: 110px; border-radius: 50%; background: var(--bronze); border: 6px double var(--brass); color: #fff; font-family: 'Rye'; cursor: pointer; box-shadow: 0 5px 15px #000; transition: 0.2s; z-index: 50; }
        #end-btn:hover { background: #b87333; transform: translateY(-50%) scale(1.05); }
        #hand-counter { position: absolute; bottom: 20px; right: 20px; font-family: 'Rye', serif; font-size: 2rem; color: var(--parchment); text-shadow: 2px 2px 0 #000; z-index: 100; pointer-events: none; }

        /* Âπ≥Êùø‰øÆÊ≠£ */
        @media (min-width: 769px) and (max-width: 1366px) {
            #battle-stage { top: 45px; transform: translateX(-50%) scale(0.9); }
            #player-hub { bottom: 240px; width: 400px; }
            #side-panel { left: 10px; transform: translateY(-50%) scale(0.85); transform-origin: left center; }
            #end-btn { width: 90px; height: 90px; right: 20px; font-size: 0.9rem; }
            .victory-title { font-size: 3rem; }
        }

        @media (max-width: 768px) {
            body { background-position: center; background-size: cover; }
            .marquee-content span { font-size: 1rem; line-height: 35px; }
            #battle-stage { top: 55px; width: 100%; flex-direction: column; gap: 5px; }
            .round-gauge { width: 50px; height: 60px; position: absolute; top: 0; right: 10px; z-index: 10; border-width: 2px; }
            .round-gauge span:first-child { font-size: 0.5rem; } .round-gauge span:last-child { font-size: 1.2rem !important; }
            .enemy-box { width: 85%; padding: 10px 15px; margin-top: 15px; } #ui-en-name { font-size: 1.3rem !important; }
            #side-panel { top: 50px; left: 10px; flex-direction: row; gap: 10px; scale: 0.7; transform-origin: top left; z-index: 20; }
            #player-hub { width: 90%; bottom: 250px; padding: 5px; }
            #hand-area { height: 190px; bottom: 0; width: 100%; perspective: 500px; overflow-x: auto; justify-content: center; align-items: flex-end; padding-bottom: 5px; }
            .card { width: 100px; height: 150px; margin: 0 -18px; }
            .card-name { font-size: 0.7rem; padding: 8px 2px; } .card-desc { font-size: 0.6rem; margin-top: 8px; }
            .card-cost { width: 25px; height: 25px; font-size: 0.9rem; top: -8px; left: -8px; } .card.selected { transform: translateY(-50px) scale(1.1) !important; }
            #end-btn { width: 70px; height: 70px; right: 10px; top: auto; bottom: 240px; transform: none; font-size: 0.8rem; border-width: 3px; z-index: 50; }
            #action-log { font-size: 1.2rem; top: 35%; }
            #hand-counter { bottom: 200px; right: 10px; font-size: 1.2rem; }
            #pile-display { bottom: 200px; left: 10px; transform: scale(0.8); transform-origin: bottom left; }
            .victory-title { font-size: 2.5rem; }
            #reward-options { flex-direction: column; gap: 10px; }
            .reward-btn { width: 100%; height: 80px; flex-direction: row; padding: 10px; gap: 20px; justify-content: flex-start; }
            .reward-icon { font-size: 2rem; margin: 0; }
            .reward-name { font-size: 1.2rem; margin: 0; } .reward-desc { display: none; }
        }
    </style>
</head>
<body onload="init()">
    <div id="marquee-container"><div class="marquee-content"><span>‚ö† WARNING: THE BOSS IS SO HARD ‚ö†&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚ö† SYSTEM ALERT: EXTREME DANGER ‚ö†&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>‚ö† WARNING: THE BOSS IS SO HARD ‚ö†&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚ö† SYSTEM ALERT: EXTREME DANGER ‚ö†&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div></div>
    
    <div id="victory-screen">
        <div class="victory-title">WAVE COMPLETE</div>
        <div class="victory-subtitle">CHOOSE YOUR REWARD</div>
        
        <div id="reward-options">
            <div class="reward-btn" onclick="showRemoveCardUI()">
                <div class="reward-icon">üî•</div>
                <div class="reward-name">PURGE</div>
                <div class="reward-desc">Remove 1 card from your deck permanently.</div>
            </div>
            <div class="reward-btn" onclick="showAddCardUI()">
                <div class="reward-icon">üÉè</div>
                <div class="reward-name">DRAFT</div>
                <div class="reward-desc">Choose 1 of 3 new cards to add to your deck.</div>
            </div>
            <div class="reward-btn" onclick="chooseHeal()">
                <div class="reward-icon">‚ù§</div>
                <div class="reward-name">REST</div>
                <div class="reward-desc">Recover 15% of your Max HP immediately.</div>
            </div>
        </div>

        <div class="warning-text">‚ö† SELECTION CANNOT BE CANCELLED. CHOOSE CAREFULLY. ‚ö†</div>
        <button id="next-lvl-btn" onclick="goToNextLevel()">NEXT BATTLE ‚û°</button>
    </div>

    <div id="card-selection-overlay">
        <div class="selection-title" id="selection-title-text">SELECT A CARD</div>
        <div id="selection-grid"></div>
    </div>

    <div id="action-log"></div>
    <div id="battle-stage">
        <div class="round-gauge"><span style="font-size:0.7rem">ROUND</span><span id="ui-round" style="font-family:'Rye'; font-size:2.2rem; color:var(--gold)">1</span></div>
        <div class="enemy-box tier-1" id="enemy-target">
            <div id="ui-en-row" style="font-size:0.7rem; color: #888;">#--</div>
            <div id="ui-en-name" style="font-family:'Rye'; font-size:1.8rem;">LOADING...</div>
            <div id="en-status" class="status-bar"></div>
            <div class="hp-container"><div id="ui-en-hp-fill" class="hp-fill" style="background: var(--danger);"></div></div>
            <div id="ui-en-hp-text" style="text-align:right; font-weight:bold; font-size: 0.9rem;">-- / --</div>
            <div id="ui-en-intent" style="color:var(--steam-blue); font-size:0.8rem; margin-top:5px; height:1rem;"></div>
        </div>
    </div>
    <div id="side-panel">
        <div class="gauge-circle"><span style="font-size:0.7rem">ENERGY</span><span id="ui-energy" style="font-family:'Rye'; font-size:2rem; color:var(--steam-blue)">3/3</span></div>
        <div class="gauge-circle"><span style="font-size:0.7rem">WAVE</span><span id="ui-wave-left" style="font-family:'Rye'; font-size:2rem">--</span></div>
    </div>
    <div id="player-hub">
        <div style="display:flex; justify-content:space-between; margin-bottom: 5px;"><span>PLAYER_CORE</span><span id="ui-pl-hp-text">100 / 100</span></div>
        <div id="pl-status" class="status-bar" style="margin-bottom:5px;"></div>
        <div class="hp-container"><div id="ui-pl-hp-fill" class="hp-fill" style="background: var(--success);"></div><div id="ui-pl-shield-fill" class="shield-fill"></div></div>
    </div>
    
    <div id="pile-display">
        <div class="pile-box"><span class="pile-label">DRAW</span><span id="ui-draw-count" class="pile-count">--</span></div>
        <div class="pile-box"><span class="pile-label">DISC</span><span id="ui-disc-count" class="pile-count">--</span></div>
    </div>
    <div id="hand-counter">0/5</div>
    
    <button id="end-btn">END<br>TURN</button>
    <div id="hand-area"></div>

    <script>
        const BASE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRuNEG1oT6a0JsP4Zy8uqFSRDKaxEM8FJetpMWOZ0vR6yg4AGqGtMlLJ_0NSxIE_tqSnOsPd9aLWtg8/pub?output=csv";
        const GID_CARD = "0"; const GID_ENEMY = "322780304"; const GID_CONFIG = "1319509950";

        let state = {
            playerHP: 100, playerMaxHP: 100, playerShield: 0, playerStr: 0,
            playerMarkers: [],
            energy: 3, maxEnergy: 3, maxHandSize: 5,
            round: 1,
            masterLibrary: [], // ÊâÄÊúâÂç°ÁâåË≥áÊñô
            deck: [],          // Áé©ÂÆ∂ÁöÑÊ∞∏‰πÖÁâåÁµÑ
            drawPile: [], discardPile: [], currentHand: [],
            enemyPool: [], waveConfig: [],
            currentWave: [], currentEnemy: null, enemyWaveIdx: 0, selectedCard: null
        };

        async function init() {
            Papa.parse(`${BASE_URL}&gid=${GID_CARD}`, { download: true, header: false, complete: (res) => {
                state.masterLibrary = res.data.slice(1).filter(r => r[0]).map((r,i)=>({ name: r[0], effect: r[1], cost: parseInt(r[2])||0, row: i+2 }));
                // ÂàùÂßãÁâåÁµÑÔºöÈö®Ê©ü 20 Âºµ (ÊàñÊòØÊÇ®ÂèØ‰ª•ÂÆöÁæ©ÂàùÂßãÁâåÁµÑ)
                state.deck = [];
                for(let i=0; i<20; i++) {
                    if(state.masterLibrary.length > 0) state.deck.push({...state.masterLibrary[Math.floor(Math.random() * state.masterLibrary.length)]});
                }
                startBattle();
            }});
            Papa.parse(`${BASE_URL}&gid=${GID_ENEMY}`, { download: true, header: false, complete: (res) => {
                state.enemyPool = res.data.slice(1).filter(r => r[0]).map((r,i)=>({ name: r[0], hp: parseInt(r[1])||10, type: parseInt(r[2])||1, actions: [r[4], r[5], r[6], r[7], r[8], r[9]].filter(a => a && a.trim() !== ""), row: i+2 }));
                Papa.parse(`${BASE_URL}&gid=${GID_CONFIG}`, { download: true, header: false, complete: (res) => {
                    state.waveConfig = res.data.slice(1).map(r => ({ n: parseInt(r[0])||0, e: parseInt(r[1])||0, b: parseInt(r[2])||0, z: parseInt(r[3])||0 }));
                    generateWave();
                }});
            }});
        }

        // ÈñãÂßãÊñ∞Êà∞È¨•ÔºöÈáçÁΩÆÊäΩÁâåÂ†Ü
        function startBattle() {
            state.drawPile = [...state.deck]; // Ë§áË£ΩÁâåÁµÑÂà∞ÊäΩÁâåÂ†Ü
            state.discardPile = [];
            state.currentHand = [];
            shuffle(state.drawPile);
            draw(5);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // --- ÁçéÂãµÈÅ∏ÊìáÈÇèËºØ ---
        function chooseHeal() {
            const healAmt = Math.floor(state.playerMaxHP * 0.15);
            state.playerHP = Math.min(state.playerMaxHP, state.playerHP + healAmt);
            alert(`Recovered ${healAmt} HP!`);
            onRewardChosen();
        }

        function showRemoveCardUI() {
            const overlay = document.getElementById('card-selection-overlay');
            const grid = document.getElementById('selection-grid');
            document.getElementById('selection-title-text').innerText = "REMOVE A CARD";
            grid.innerHTML = '';
            overlay.style.display = 'flex';

            state.deck.forEach((card, index) => {
                const el = createCardElement(card);
                el.onclick = () => {
                    if(confirm(`Remove ${card.name}?`)) {
                        state.deck.splice(index, 1);
                        overlay.style.display = 'none';
                        onRewardChosen();
                    }
                };
                grid.appendChild(el);
            });
        }

        function showAddCardUI() {
            const overlay = document.getElementById('card-selection-overlay');
            const grid = document.getElementById('selection-grid');
            document.getElementById('selection-title-text').innerText = "CHOOSE A NEW CARD";
            grid.innerHTML = '';
            overlay.style.display = 'flex';

            // Èö®Ê©üÈÅ∏ 3 ÂºµÊñ∞Âç°
            for(let i=0; i<3; i++) {
                const card = state.masterLibrary[Math.floor(Math.random() * state.masterLibrary.length)];
                const el = createCardElement(card);
                el.onclick = () => {
                    if(confirm(`Add ${card.name} to deck?`)) {
                        state.deck.push({...card});
                        overlay.style.display = 'none';
                        onRewardChosen();
                    }
                };
                grid.appendChild(el);
            }
        }

        function createCardElement(d) {
            const el = document.createElement('div');
            el.className = 'card';
            let niceDesc = formatCardText(d.effect);
            el.innerHTML = `<div class="card-cost">${d.cost}</div><div class="card-name">${d.name}</div><div class="card-desc">${niceDesc}</div>`;
            return el;
        }

        function onRewardChosen() {
            document.getElementById('reward-options').style.display = 'none';
            document.querySelector('.warning-text').style.display = 'none';
            document.querySelector('.victory-subtitle').innerText = "PREPARE FOR NEXT BATTLE";
            document.getElementById('next-lvl-btn').style.display = 'block';
        }

        function goToNextLevel() {
            document.getElementById('victory-screen').style.display = 'none';
            // ÈáçÁΩÆ‰ªãÈù¢ÁãÄÊÖã
            document.getElementById('reward-options').style.display = 'flex';
            document.querySelector('.warning-text').style.display = 'block';
            document.querySelector('.victory-subtitle').innerText = "CHOOSE YOUR REWARD";
            document.getElementById('next-lvl-btn').style.display = 'none';
            
            state.round++;
            generateWave();
            startBattle(); // ÈáçÊñ∞Ê¥óÁâå
        }

        // --- ÈÅäÊà≤Ê†∏ÂøÉÈÇèËºØ ---
        function resolveVal(valStr) {
            if (!valStr || valStr.toString().trim() === "") return 1;
            if (isNaN(valStr) && !valStr.includes('{')) return 1;
            if (!isNaN(valStr)) return parseFloat(valStr);
            const en = state.currentEnemy;
            const handCount = state.currentHand.length;
            const waveLeft = state.currentWave ? (state.currentWave.length - state.enemyWaveIdx) : 0;
            let expr = valStr.toString().toLowerCase()
                .replace(/{hp}/g, state.playerHP).replace(/{mhp}/g, state.playerMaxHP).replace(/{shd}/g, state.playerShield)
                .replace(/{str}/g, state.playerStr).replace(/{eng}/g, state.energy).replace(/{max_eng}/g, state.maxEnergy)
                .replace(/{loss}/g, (state.playerMaxHP - state.playerHP)).replace(/{hand}/g, handCount).replace(/{max_hand}/g, state.maxHandSize)
                .replace(/{draw_pile}/g, state.drawPile.length).replace(/{disc_pile}/g, state.discardPile.length)
                .replace(/{round}/g, state.round).replace(/{wave}/g, waveLeft)
                .replace(/{en_hp}/g, en ? en.curHP : 0).replace(/{en_mhp}/g, en ? en.hp : 0).replace(/{en_loss}/g, en ? (en.hp - en.curHP) : 0)
                .replace(/{en_psn}/g, en ? en.poison : 0).replace(/{en_vuln}/g, en ? en.vulnerable : 0).replace(/{en_weak}/g, en ? en.weak : 0).replace(/{en_type}/g, en ? en.type : 1);
            try { return Math.floor(new Function('return ' + expr)()); } catch (e) { return 0; }
        }

        function generateWave() {
            const cfg = state.waveConfig[state.round - 1];
            if(!cfg) return alert("Victory! You have conquered all waves.");
            let wave = [];
            const add = (type, count) => { const p = state.enemyPool.filter(en => en.type === type); for(let i=0; i<count; i++) if(p.length) wave.push({...p[Math.floor(Math.random()*p.length)]}); };
            add(1, cfg.n); add(2, cfg.e); add(3, cfg.b); add(4, cfg.z);
            state.currentWave = wave; state.enemyWaveIdx = 0; spawnNext();
        }

        function spawnNext() {
            document.body.classList.remove('boss-mode');
            if(state.enemyWaveIdx >= state.currentWave.length) {
                document.getElementById('victory-screen').style.display = 'flex';
                return;
            }
            const raw = state.currentWave[state.enemyWaveIdx];
            state.currentEnemy = { ...raw, curHP: raw.hp, actionStep: 0, poison: 0, vulnerable: 0, weak: 0, stunned: false, markers: [] };
            state.enemyWaveIdx++;
            const box = document.getElementById('enemy-target');
            box.className = 'enemy-box tier-' + state.currentEnemy.type;
            if (state.currentEnemy.type === 4) { document.body.classList.add('boss-mode'); showLog("‚ö† BOSS WARNING ‚ö†"); if(navigator.vibrate) navigator.vibrate([200, 100, 200]); }
            updateUI();
        }

        function draw(n) {
            const area = document.getElementById('hand-area');
            const slotsLeft = state.maxHandSize - state.currentHand.length;
            let toDraw = Math.min(n, slotsLeft);
            if (toDraw <= 0 && n > 0) { showLog("HAND FULL!"); return; }
            for(let i=0; i<toDraw; i++){
                if(state.drawPile.length === 0) {
                    if(state.discardPile.length > 0) {
                        state.drawPile = [...state.discardPile]; state.discardPile = []; shuffle(state.drawPile); showLog("SHUFFLE");
                    } else { showLog("NO CARDS"); break; }
                }
                const d = state.drawPile.pop();
                state.currentHand.push(d); 
                const el = document.createElement('div');
                el.className = 'card';
                el.innerHTML = `<div class="card-cost">${d.cost}</div><div class="card-name">${d.name}</div><div class="card-desc">${formatCardText(d.effect)}</div>`;
                const rot = (Math.random() * 6 - 3).toFixed(1);
                el.style.transform = `rotate(${rot}deg)`;
                el.onclick = (e) => { e.stopPropagation(); if(state.energy >= d.cost) { select(el, d); if(navigator.vibrate) navigator.vibrate(10); } else { showLog("NOT ENOUGH ENERGY"); if(navigator.vibrate) navigator.vibrate(50); }};
                area.appendChild(el);
            }
            updateUI();
        }

        function formatCardText(text) {
            let t = text;
            t = t.replace(/\[#once\]/g, '<span class="tag-badge bg-once">ONCE</span>');
            t = t.replace(/\[#mark\s+(.*?)\]/g, '<span class="tag-badge bg-mark">$1</span>');
            t = t.replace(/\[#req\s+(.*?)\]/g, '<span class="tag-badge bg-req">REQ: $1</span>');
            t = t.replace(/\[#reqme\s+(.*?)\]/g, '<span class="tag-badge bg-req">NEED: $1</span>');
            t = t.replace(/\[#unmark\s+(.*?)\]/g, '<span class="tag-badge bg-draw">CLR: $1</span>');
            t = t.replace(/\[#hand_limit\s+(.*?)\]/g, '<span class="tag-badge bg-draw">HAND MAX $1</span>');
            t = t.replace(/\[#dmg\s+(.*?)\]/g, '<span class="tag-badge bg-dmg">DMG $1</span>');
            t = t.replace(/\[#def\s+(.*?)\]/g, '<span class="tag-badge bg-def">DEF $1</span>');
            t = t.replace(/\[#heal\s+(.*?)\]/g, '<span class="tag-badge bg-heal">HEAL $1</span>');
            t = t.replace(/\[#psn\s+(.*?)\]/g, '<span class="tag-badge bg-psn">PSN $1</span>');
            t = t.replace(/\[#eng\s+(.*?)\]/g, '<span class="tag-badge bg-eng">ENG +$1</span>');
            t = t.replace(/\[#draw\s+(.*?)\]/g, '<span class="tag-badge bg-draw">DRAW $1</span>');
            t = t.replace(/\[#sdmg\s+(.*?)\]/g, '<span class="tag-badge bg-sdmg">HURT $1</span>');
            t = t.replace(/\[#str\s+(.*?)\]/g, '<span class="tag-badge bg-str">STR +$1</span>');
            t = t.replace(/\[#weak\s+(.*?)\]/g, '<span class="tag-badge bg-weak">WEAK $1</span>');
            t = t.replace(/\[#vuln\s+(.*?)\]/g, '<span class="tag-badge bg-vuln">VULN $1</span>');
            t = t.replace(/\[#stun\s+(.*?)\]/g, '<span class="tag-badge bg-stun">STUN</span>');
            t = t.replace(/\[#drain\s+(.*?)\]/g, '<span class="tag-badge bg-drain">DRAIN $1</span>');
            t = t.replace(/\[#pure\s+(.*?)\]/g, '<span class="tag-badge bg-pure">PURE $1</span>');
            t = t.replace(/\[#maxhp\s+(.*?)\]/g, '<span class="tag-badge bg-maxhp">MAXHP +$1</span>');
            return t;
        }

        function select(el, d) {
            const reqMatch = /\[#req\s+(.*?)\]/.exec(d.effect);
            if (reqMatch && !state.currentEnemy.markers.includes(reqMatch[1].trim())) { showLog(`REQ: ${reqMatch[1]}`); if(navigator.vibrate) navigator.vibrate(50); return cancel(); }
            const reqMeMatch = /\[#reqme\s+(.*?)\]/.exec(d.effect);
            if (reqMeMatch && !state.playerMarkers.includes(reqMeMatch[1].trim())) { showLog(`NEED: ${reqMeMatch[1]}`); if(navigator.vibrate) navigator.vibrate(50); return cancel(); }
            if(state.selectedCard?.el === el) return cancel();
            cancel(); state.selectedCard = {el, d}; el.classList.add('selected');
            if(/\[#(dmg|psn|weak|vuln|stun|drain|pure|mark|unmark|req)/.test(d.effect)) document.getElementById('enemy-target').classList.add('target-active');
            if(/\[#(heal|def|eng|draw|sdmg|str|maxhp|reqme|hand_limit)/.test(d.effect)) document.getElementById('player-hub').classList.add('target-active');
        }

        function cancel() {
            if(state.selectedCard) state.selectedCard.el.classList.remove('selected');
            state.selectedCard = null; document.querySelectorAll('.target-active').forEach(e => e.classList.remove('target-active'));
        }

        document.getElementById('enemy-target').onclick = () => { if(state.selectedCard) applyCardEffect("enemy"); };
        document.getElementById('player-hub').onclick = () => { if(state.selectedCard) applyCardEffect("player"); };

        function applyCardEffect(target) {
            const d = state.selectedCard.d;
            state.energy -= d.cost;
            const reg = /\[#(\w+)\s*(.*?)\]/g; let m;
            while((m = reg.exec(d.effect)) !== null) {
                const tag = m[1], rawVal = m[2], val = resolveVal(rawVal);
                if(tag === 'hand_limit') { state.maxHandSize = Math.max(0, state.maxHandSize + val); showLog(`HAND LIMIT ${val > 0 ? '+' : ''}${val}`); }
                if(tag === 'mark') { const n = rawVal.trim(); target === 'enemy' ? state.currentEnemy.markers.push(n) : state.playerMarkers.push(n); showLog(`MARKED: ${n}`); }
                if(tag === 'unmark') { const n = rawVal.trim(); const arr = target === 'enemy' ? state.currentEnemy.markers : state.playerMarkers; const idx = arr.indexOf(n); if(idx>-1){arr.splice(idx,1); showLog(`CLEARED: ${n}`);} }
                if(tag === 'dmg' && target === 'enemy') damageEnemy(val);
                if(tag === 'pure' && target === 'enemy') { state.currentEnemy.curHP -= val; showLog(`PURE DMG: ${val}`); visualFlash('enemy-target', 'pure'); }
                if(tag === 'drain' && target === 'enemy') { const actualDmg = damageEnemy(val); healPlayer(actualDmg); }
                if(tag === 'psn' && target === 'enemy') { state.currentEnemy.poison += val; showLog(`POISON: ${val}`); }
                if(tag === 'weak' && target === 'enemy') { state.currentEnemy.weak += val; showLog(`WEAK: ${val} Turns`); }
                if(tag === 'vuln' && target === 'enemy') { state.currentEnemy.vulnerable += val; showLog(`VULNERABLE: ${val} Turns`); }
                if(tag === 'stun' && target === 'enemy') { state.currentEnemy.stunned = true; showLog(`STUNNED!`); }
                if(tag === 'def') { state.playerShield += val; showLog(`SHIELD: ${val}`); }
                if(tag === 'str') { state.playerStr += val; showLog(`STRENGTH UP: ${val}`); }
                if(tag === 'heal') healPlayer(val);
                if(tag === 'maxhp') { state.playerMaxHP += val; state.playerHP += val; showLog(`MAX HP UP: ${val}`); }
                if(tag === 'eng') { state.energy = Math.min(10, state.energy + val); showLog(`ENERGY +${val}`); }
                if(tag === 'draw') { draw(val); showLog(`DRAW ${val}`); }
                if(tag === 'sdmg') { state.playerHP -= val; showLog(`SACRIFICE: ${val}`); }
            }
            const handIdx = state.currentHand.indexOf(d); if (handIdx > -1) state.currentHand.splice(handIdx, 1);
            if (d.effect.includes('[#once]')) showLog("BANISHED"); else state.discardPile.push(d);
            state.selectedCard.el.remove(); cancel(); checkWin(); updateUI();
        }

        function damageEnemy(baseDmg) {
            let dmg = baseDmg + state.playerStr; if(state.currentEnemy.vulnerable > 0) dmg = Math.floor(dmg * 1.5);
            state.currentEnemy.curHP -= dmg; showLog(`HIT: ${dmg}`); visualFlash('enemy-target', 'dmg'); return dmg;
        }
        function healPlayer(amt) { state.playerHP = Math.min(state.playerMaxHP, state.playerHP + amt); showLog(`HEAL: ${amt}`); }
        function enemyHeal(amt) { state.currentEnemy.curHP = Math.min(state.currentEnemy.hp, state.currentEnemy.curHP + amt); showLog(`ENEMY HEAL: ${amt}`); visualFlash('enemy-target', 'pure'); }
        function checkWin() { if(state.currentEnemy && state.currentEnemy.curHP <= 0) spawnNext(); }
        function playerTakeDamage(amt) {
            let incoming = amt; if(state.currentEnemy.weak > 0) incoming = Math.floor(incoming * 0.75);
            let remain = incoming; if(state.playerShield > 0) { if(state.playerShield >= remain) { state.playerShield -= remain; remain = 0; showLog(`BLOCKED!`); } else { remain -= state.playerShield; state.playerShield = 0; } }
            if(remain > 0) { state.playerHP -= remain; showLog(`TOOK ${remain} DMG`); visualFlash('player-hub', 'dmg'); } updateUI();
        }

        document.getElementById('end-btn').onclick = () => {
            if(!state.currentEnemy) return;
            document.getElementById('hand-area').innerHTML = '';
            state.currentHand.forEach(card => state.discardPile.push(card)); state.currentHand = [];
            if(state.currentEnemy.poison > 0) { const pDmg = state.currentEnemy.poison; state.currentEnemy.curHP -= pDmg; state.currentEnemy.poison = Math.max(0, state.currentEnemy.poison - 1); showLog(`POISON DMG: ${pDmg}`); if(state.currentEnemy.curHP <= 0) { spawnNext(); startPlayerTurn(); return; } }
            if(state.currentEnemy.stunned) { showLog("ENEMY STUNNED!"); state.currentEnemy.stunned = false; } else { enemyAction(); }
            if(state.currentEnemy.vulnerable > 0) state.currentEnemy.vulnerable--; if(state.currentEnemy.weak > 0) state.currentEnemy.weak--;
            startPlayerTurn();
        };

        function enemyAction() {
            const acts = state.currentEnemy.actions; if(!acts.length) return;
            const currentAct = acts[state.currentEnemy.actionStep % acts.length];
            const reg = /\[#(\w+)\s*(.*?)\]/g; let m;
            while((m = reg.exec(currentAct)) !== null) {
                const tag = m[1], rawVal = m[2], val = resolveVal(rawVal);
                if(tag === 'dmg') playerTakeDamage(val); if(tag === 'heal') enemyHeal(val);
                if(tag === 'mark') { state.playerMarkers.push(rawVal.trim()); showLog(`ENEMY MARKED: ${rawVal.trim()}`); }
                if(tag === 'unmark') { const idx = state.playerMarkers.indexOf(rawVal.trim()); if(idx > -1) { state.playerMarkers.splice(idx, 1); showLog(`UNMARKED: ${rawVal.trim()}`); }}
            }
            state.currentEnemy.actionStep++;
        }

        function startPlayerTurn() { state.playerShield = 0; state.energy = state.maxEnergy; draw(5); updateUI(); }
        function showLog(msg) { const log = document.getElementById('action-log'); log.innerText = msg; log.style.opacity = 1; log.style.transform = "translateY(-20px)"; log.style.transition = "0s"; setTimeout(()=>{ log.style.transition = "1s"; log.style.opacity = 0; log.style.transform = "translateY(0)"; }, 800); }
        function visualFlash(id, type) { const el = document.getElementById(id); if(type === 'dmg') el.style.filter = "brightness(2) sepia(1) hue-rotate(-50deg) saturate(5)"; if(type === 'pure') el.style.filter = "invert(1)"; setTimeout(()=> el.style.filter = "", 100); }
        function getGroupedMarkers(markers) { const counts = {}; markers.forEach(m => { counts[m] = (counts[m] || 0) + 1; }); return Object.entries(counts).map(([name, count]) => ({name, count})); }

        function updateUI() {
            document.getElementById('hand-counter').innerText = `${state.currentHand.length}/${state.maxHandSize}`;
            document.getElementById('ui-draw-count').innerText = state.drawPile.length;
            document.getElementById('ui-disc-count').innerText = state.discardPile.length;
            if(state.currentEnemy) {
                document.getElementById('ui-en-name').innerText = state.currentEnemy.name;
                document.getElementById('ui-en-row').innerText = `Row: ${state.currentEnemy.row}`;
                const enPct = (state.currentEnemy.curHP / state.currentEnemy.hp) * 100;
                document.getElementById('ui-en-hp-fill').style.width = Math.max(0, enPct) + '%';
                document.getElementById('ui-en-hp-text').innerText = `${state.currentEnemy.curHP} / ${state.currentEnemy.hp}`;
                const sBar = document.getElementById('en-status'); sBar.innerHTML = '';
                getGroupedMarkers(state.currentEnemy.markers).forEach(item => { const cls = 'marker-' + item.name.toLowerCase(); const countStr = item.count > 1 ? ` x${item.count}` : ''; sBar.innerHTML += `<div class="status-text ${cls}">${item.name}${countStr}</div>`; });
                const addIcon = (txt, cls) => sBar.innerHTML += `<div class="status-icon ${cls}">${txt}</div>`;
                if(state.currentEnemy.poison > 0) addIcon(`‚ò† ${state.currentEnemy.poison}`, 'st-poison');
                if(state.currentEnemy.vulnerable > 0) addIcon(`üíî ${state.currentEnemy.vulnerable}`, 'st-vuln');
                if(state.currentEnemy.weak > 0) addIcon(`üìâ ${state.currentEnemy.weak}`, 'st-weak');
                if(state.currentEnemy.stunned) addIcon(`‚ö° STUN`, 'st-stun');
                const acts = state.currentEnemy.actions;
                if(acts.length) { document.getElementById('ui-en-intent').innerText = `INTENT: ${acts[state.currentEnemy.actionStep % acts.length]}`; }
            }
            document.getElementById('ui-round').innerText = state.round;
            document.getElementById('ui-energy').innerText = `${state.energy}/${state.maxEnergy}`;
            document.getElementById('ui-wave-left').innerText = Math.max(0, state.currentWave.length - state.enemyWaveIdx);
            document.getElementById('ui-pl-hp-text').innerText = `${state.playerHP} / ${state.playerMaxHP}`;
            document.getElementById('ui-pl-hp-fill').style.width = Math.max(0, (state.playerHP/state.playerMaxHP)*100) + '%';
            const sFill = document.getElementById('ui-pl-shield-fill');
            sFill.style.width = state.playerShield > 0 ? Math.min(100, (state.playerShield/state.playerMaxHP)*100) + '%' : '0%';
            const pBar = document.getElementById('pl-status'); pBar.innerHTML = '';
            getGroupedMarkers(state.playerMarkers).forEach(item => { const cls = 'marker-' + item.name.toLowerCase(); const countStr = item.count > 1 ? ` x${item.count}` : ''; pBar.innerHTML += `<div class="status-text ${cls}">${item.name}${countStr}</div>`; });
            const addPIcon = (txt, cls) => pBar.innerHTML += `<div class="status-icon ${cls}">${txt}</div>`;
            if(state.playerShield > 0) addPIcon(`üõ° ${state.playerShield}`, 'st-shield');
            if(state.playerStr > 0) addPIcon(`üí™ ${state.playerStr}`, 'st-str');
            if(state.playerHP <= 0) { setTimeout(() => { alert("SYSTEM FAILURE. RELOAD."); location.reload(); }, 100); }
        }
        document.body.onclick = cancel;
        window.onload = init;
    </script>
</body>
</html>
