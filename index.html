<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Steampunk Duelist - Advanced AI & Wave System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Rye&display=swap" rel="stylesheet">
    <style>
        :root {
            --brass: #b5a642; --bronze: #cd7f32; --gold: #ffd700;
            --leather: #4a3c31; --parchment: #eaddcf; --steam-blue: #00f3ff;
            --danger: #ff4444; --success: #44ff44;
        }

        body {
            margin: 0; padding: 0; background: #120f0d;
            color: var(--parchment); font-family: 'IM Fell English SC', serif;
            overflow: hidden; height: 100vh;
            background-image: radial-gradient(circle, #2a221b 0%, #120f0d 100%);
        }

        /* --- 戰鬥佈局 --- */
        #battle-stage {
            position: absolute; top: 50px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: center; gap: 40px;
        }

        .round-gauge {
            width: 80px; height: 100px; background: var(--leather); border: 3px double var(--brass);
            border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .enemy-box {
            width: 420px; background: #222; border: 6px ridge var(--bronze);
            padding: 25px; border-radius: 5px; position: relative; cursor: pointer; transition: 0.3s;
        }
        
        /* 敵人類型視覺與抖動 */
        .tier-1 { border-color: var(--bronze); animation: shake-1 1s infinite; }
        .tier-2 { border-color: #c0c0c0; box-shadow: 0 0 15px rgba(255,255,255,0.2); animation: shake-2 0.4s infinite; }
        .tier-3 { border-color: var(--gold); box-shadow: 0 0 30px rgba(255,215,0,0.4); animation: shake-3 0.15s infinite; }

        @keyframes shake-1 { 0%, 100% { transform: translate(0,0); } 50% { transform: translate(1px,1px); } }
        @keyframes shake-2 { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } }
        @keyframes shake-3 { 0% { transform: translate(3px, 3px); } 50% { transform: translate(-3px, -3px); } }

        /* --- 操作回饋 --- */
        .target-active { outline: 3px solid var(--steam-blue); box-shadow: 0 0 25px var(--steam-blue); }

        /* --- 左側儀表板 --- */
        #side-panel {
            position: absolute; left: 30px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 20px;
        }
        .gauge-circle {
            width: 100px; height: 100px; border: 4px solid var(--brass); border-radius: 50%;
            background: radial-gradient(circle, var(--leather), #111);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* --- 卡牌設計 --- */
        #hand-area {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; height: 260px; display: flex; justify-content: center; align-items: flex-end;
        }
        .card {
            width: 160px; height: 230px; background: var(--parchment); color: #2a1a0a;
            border: 5px solid var(--bronze); border-radius: 12px; margin: 0 -5px;
            cursor: pointer; position: relative; transition: 0.2s;
            background-image: url('https://www.transparenttextures.com/patterns/pinstriped-suit.png');
        }
        .card.selected { transform: translateY(-50px); border-color: var(--steam-blue); box-shadow: 0 0 20px var(--steam-blue); }
        .card-cost {
            position: absolute; top: -15px; left: -15px; width: 40px; height: 40px;
            background: #222; color: var(--steam-blue); border: 2px solid var(--steam-blue);
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Rye';
        }
        .card-effect-num { margin-top: 40px; text-align: center; font-size: 1.8rem; font-family: 'Rye'; color: var(--bronze); }
        .card-row { position: absolute; bottom: 8px; right: 12px; font-size: 0.8rem; color: #842; }

        /* --- 血量條 --- */
        .hp-container { width: 100%; height: 20px; background: #000; border-radius: 10px; border: 2px solid var(--brass); overflow: hidden; margin: 10px 0; }
        .hp-fill { height: 100%; width: 100%; transition: 0.5s; }

        #player-hub { position: absolute; bottom: 320px; left: 50%; transform: translateX(-50%); width: 450px; cursor: pointer; padding: 10px; border-radius: 10px; }

        #end-btn {
            position: absolute; right: 40px; top: 50%; transform: translateY(-50%);
            width: 100px; height: 100px; border-radius: 50%; background: var(--bronze);
            border: 6px double var(--brass); color: #fff; font-family: 'Rye'; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="battle-stage">
        <div class="round-gauge">
            <span style="font-size:0.7rem">ROUND</span>
            <span id="ui-round" style="font-family:'Rye'; font-size:2.2rem; color:var(--gold)">1</span>
        </div>
        <div class="enemy-box tier-1" id="enemy-target">
            <div id="ui-en-row" style="font-size:0.7rem; color: #888;">#--</div>
            <div id="ui-en-name" style="font-family:'Rye'; font-size:1.8rem;">LOADING...</div>
            <div class="hp-container"><div id="ui-en-hp-fill" class="hp-fill" style="background: var(--danger);"></div></div>
            <div id="ui-en-hp-text" style="text-align:right; font-size: 0.9rem;">-- / --</div>
        </div>
    </div>

    <div id="side-panel">
        <div class="gauge-circle">
            <span style="font-size:0.7rem">ENERGY</span>
            <span id="ui-energy" style="font-family:'Rye'; font-size:2rem; color:var(--steam-blue)">3/3</span>
        </div>
        <div class="gauge-circle">
            <span style="font-size:0.7rem">WAVE LEFT</span>
            <span id="ui-wave-left" style="font-family:'Rye'; font-size:2rem">--</span>
        </div>
    </div>

    <div id="player-hub">
        <div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
            <span>PLAYER_SYSTEM</span>
            <span id="ui-pl-hp-text">100 / 100</span>
        </div>
        <div class="hp-container"><div id="ui-pl-hp-fill" class="hp-fill" style="background: var(--success);"></div></div>
    </div>

    <button id="end-btn">END<br>ACTION</button>
    <div id="hand-area"></div>

    <script>
        const BASE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRuNEG1oT6a0JsP4Zy8uqFSRDKaxEM8FJetpMWOZ0vR6yg4AGqGtMlLJ_0NSxIE_tqSnOsPd9aLWtg8/pub?output=csv";
        const GID_CARD = "0";
        const GID_ENEMY = "322780304";
        const GID_CONFIG = "1319509950";

        let state = {
            playerHP: 100, energy: 3, round: 1,
            cardPool: [], enemyPool: [], waveConfig: [],
            currentWave: [], currentEnemy: null, enemyWaveIdx: 0,
            selectedCard: null
        };

        async function init() {
            // 1. 讀取卡片
            Papa.parse(`${BASE_URL}&gid=${GID_CARD}`, { download: true, header: true, complete: (res) => {
                state.cardPool = res.data.filter(r => Object.values(r)[0]).map((r,i)=>({
                    name: Object.values(r)[0], effect: Object.values(r)[1], cost: parseInt(Object.values(r)[2])||0, row: i+2
                }));
                draw(5);
            }});

            // 2. 讀取所有敵人資料 (包含 E-J 欄行動)
            Papa.parse(`${BASE_URL}&gid=${GID_ENEMY}`, { download: true, header: true, complete: (res) => {
                state.enemyPool = res.data.filter(r => Object.values(r)[0]).map((r,i)=>{
                    const v = Object.values(r);
                    return { name: v[0], hp: parseInt(v[1])||10, type: parseInt(v[2])||1, actions: v.slice(4,10).filter(a=>a), row: i+2 };
                });
                // 3. 讀取波次配置
                Papa.parse(`${BASE_URL}&gid=${GID_CONFIG}`, { download: true, header: true, complete: (res) => {
                    state.waveConfig = res.data.map(r => ({
                        n: parseInt(Object.values(r)[0])||0, e: parseInt(Object.values(r)[1])||0, b: parseInt(Object.values(r)[2])||0
                    }));
                    generateWave();
                }});
            }});
        }

        function generateWave() {
            const cfg = state.waveConfig[state.round - 1];
            if(!cfg) return alert("Game Clear!");
            
            let wave = [];
            const add = (type, count) => {
                const p = state.enemyPool.filter(en => en.type === type);
                for(let i=0; i<count; i++) if(p.length) wave.push({...p[Math.floor(Math.random()*p.length)]});
            };
            add(1, cfg.n); add(2, cfg.e); add(3, cfg.b);
            
            state.currentWave = wave;
            state.enemyWaveIdx = 0;
            spawnNextInWave();
        }

        function spawnNextInWave() {
            if(state.enemyWaveIdx < state.currentWave.length) {
                const raw = state.currentWave[state.enemyWaveIdx];
                state.currentEnemy = { ...raw, curHP: raw.hp, actionStep: 0 };
                state.enemyWaveIdx++;
                const box = document.getElementById('enemy-target');
                box.className = `enemy-box tier-${state.currentEnemy.type}`;
                updateUI();
            } else {
                state.round++; // 該波敵人全死，增加 Round
                generateWave();
            }
        }

        function draw(n) {
            const area = document.getElementById('hand-area');
            area.innerHTML = '';
            for(let i=0; i<n; i++){
                const d = state.cardPool[Math.floor(Math.random()*state.cardPool.length)];
                if(!d) continue;
                const el = document.createElement('div');
                el.className = 'card';
                const showEff = d.effect.replace(/\[#\w+\s+(-?\d+)\]/g, '$1');
                el.innerHTML = `<div class="card-cost">${d.cost}</div><div style="padding:10px;text-align:center;font-family:'Rye'">${d.name}</div><div class="card-effect-num">${showEff}</div><div class="card-row">${d.row}</div>`;
                el.onclick = (e) => { e.stopPropagation(); if(state.energy>=d.cost) select(el, d); };
                area.appendChild(el);
            }
        }

        function select(el, d) {
            if(state.selectedCard?.el === el) return cancel();
            cancel();
            state.selectedCard = {el, d};
            el.classList.add('selected');
            document.getElementById('enemy-target').classList.add('target-active');
            document.getElementById('player-hub').classList.add('target-active');
        }

        function cancel() {
            if(state.selectedCard) state.selectedCard.el.classList.remove('selected');
            state.selectedCard = null;
            document.querySelectorAll('.target-active').forEach(e => e.classList.remove('target-active'));
        }

        document.getElementById('enemy-target').onclick = () => { if(state.selectedCard) use("enemy"); };
        document.getElementById('player-hub').onclick = () => { if(state.selectedCard) use("player"); };

        function use(target) {
            const d = state.selectedCard.d;
            state.energy -= d.cost;
            const reg = /\[#(\w+)\s+(-?\d+)\]/g; let m;
            while((m = reg.exec(d.effect)) !== null) {
                const tag = m[1], val = parseInt(m[2]);
                if(tag === 'dmg' && target === 'enemy') state.currentEnemy.curHP -= val;
                if(tag === 'heal') state.playerHP = Math.min(100, state.playerHP + val);
            }
            state.selectedCard.el.remove();
            cancel();
            if(state.currentEnemy.curHP <= 0) spawnNextInWave();
            updateUI();
        }

        function enemyAI() {
            if(!state.currentEnemy) return;
            const actions = state.currentEnemy.actions;
            if(!actions.length) return;
            const act = actions[state.currentEnemy.actionStep % actions.length];
            const reg = /\[#(\w+)\s+(-?\d+)\]/g; let m;
            while((m = reg.exec(act)) !== null) {
                const tag = m[1], val = parseInt(m[2]);
                if(tag === 'dmg') state.playerHP -= val;
            }
            state.currentEnemy.actionStep++;
        }

        document.getElementById('end-btn').onclick = () => {
            enemyAI(); // 結束行動時敵人反擊
            state.energy = 3;
            draw(5);
            updateUI();
        };

        function updateUI() {
            if(state.currentEnemy) {
                document.getElementById('ui-en-name').innerText = state.currentEnemy.name;
                document.getElementById('ui-en-row').innerText = `Sheet Row: ${state.currentEnemy.row}`;
                document.getElementById('ui-en-hp-fill').style.width = (state.currentEnemy.curHP/state.currentEnemy.hp*100)+'%';
                document.getElementById('ui-en-hp-text').innerText = `${state.currentEnemy.curHP} / ${state.currentEnemy.hp}`;
            }
            document.getElementById('ui-round').innerText = state.round;
            document.getElementById('ui-energy').innerText = `${state.energy}/3`;
            document.getElementById('ui-wave-left').innerText = state.currentWave.length - state.enemyWaveIdx;
            document.getElementById('ui-pl-hp-text').innerText = `${state.playerHP} / 100`;
            document.getElementById('ui-pl-hp-fill').style.width = state.playerHP + '%';
        }

        document.body.onclick = cancel;
        window.onload = init;
    </script>
</body>
</html>
