<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Steampunk Duel v3.5 - Live Data</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Rye&display=swap" rel="stylesheet">
    <style>
        :root {
            --brass: #b5a642; --bronze: #cd7f32; --leather: #4a3c31;
            --parchment: #eaddcf; --dark-metal: #2c2c2c; --glow: #ffae00;
            --steam-blue: #00f3ff;
        }

        body {
            margin: 0; padding: 0; background: #1a1510;
            color: var(--parchment); font-family: 'IM Fell English SC', serif;
            overflow: hidden; height: 100vh;
        }

        /* --- 敵人 1對1 區域 --- */
        #enemy-hud {
            position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: center; gap: 20px;
        }

        .enemy-box {
            width: 380px; background: var(--dark-metal); border: 4px ridge var(--brass);
            padding: 20px; position: relative; transition: border-color 0.2s;
        }

        .type-1 { border-color: var(--bronze); }
        .type-2 { border-color: #c0c0c0; box-shadow: 0 0 10px rgba(255,255,255,0.3); }
        .type-3 { border-color: var(--glow); box-shadow: 0 0 20px rgba(255,174,0,0.4); }

        .row-info-label { font-size: 0.7rem; color: #888; font-family: monospace; }

        /* --- 左側狀態儀表 --- */
        #left-stats {
            position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 15px;
        }

        .stat-gauge {
            width: 110px; background: var(--leather); border: 3px solid var(--bronze);
            border-radius: 12px; padding: 10px; text-align: center;
        }

        /* --- 手牌與卡牌 --- */
        #hand-area {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; height: 260px; display: flex; justify-content: center;
            align-items: flex-end; pointer-events: none;
        }

        .card {
            width: 150px; height: 220px; background: var(--parchment); color: #221100;
            border: 4px solid var(--bronze); border-radius: 10px; margin: 0 -10px;
            pointer-events: auto; cursor: grab; position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .card-row-tag {
            position: absolute; bottom: 8px; right: 12px; 
            font-size: 0.7rem; color: #775533; font-family: monospace;
        }

        .card-cost-tag {
            position: absolute; top: -12px; left: -12px; width: 38px; height: 38px;
            background: var(--dark-metal); color: var(--steam-blue);
            border: 2px solid var(--steam-blue); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-family: 'Rye'; font-size: 1.2rem;
        }

        .dragging {
            position: fixed !important; z-index: 9999 !important;
            pointer-events: none !important; transform: scale(0.8) !important;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }

        .hp-bar { width: 100%; height: 14px; background: #000; border-radius: 7px; overflow: hidden; margin: 8px 0; }
        .hp-fill { height: 100%; transition: 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); background: #d93d3d; }
        
        #end-action-btn {
            position: absolute; right: 40px; top: 50%; transform: translateY(-50%);
            width: 100px; height: 100px; border-radius: 50%;
            background: radial-gradient(circle, var(--bronze), var(--leather));
            border: 5px double var(--brass); color: white; font-family: 'Rye'; cursor: pointer;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #end-action-btn:active { transform: translateY(-50%) scale(0.95); }
    </style>
</head>
<body>

    <div id="enemy-hud">
        <div class="enemy-box" id="active-enemy-zone">
            <div class="row-info-label" id="enemy-row-display">Sheet Row: --</div>
            <div id="enemy-name" style="font-family:'Rye'; font-size:1.6rem; color:var(--bronze)">CONNECTING...</div>
            <div class="hp-bar"><div id="enemy-hp-fill" class="hp-fill" style="width: 100%"></div></div>
            <div id="enemy-hp-text" style="text-align:right; font-size:0.85rem; font-weight:bold">-- / --</div>
        </div>
    </div>

    <div id="left-stats">
        <div class="stat-gauge">
            <div style="font-size:0.7rem">ENERGY</div>
            <div id="energy-val" style="font-family:'Rye'; font-size:2.2rem; color:var(--steam-blue)">--</div>
        </div>
        <div class="stat-gauge">
            <div style="font-size:0.7rem">LEFT</div>
            <div id="enemies-left" style="font-family:'Rye'; font-size:2rem">--</div>
        </div>
        <div class="stat-gauge">
            <div style="font-size:0.7rem">ROUND</div>
            <div id="round-val" style="font-family:'Rye'; font-size:1.6rem; color:var(--glow)">1</div>
        </div>
    </div>

    <button id="end-action-btn">END<br>ACTION</button>
    <div id="hand-area"></div>

    <script>
        const BASE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRuNEG1oT6a0JsP4Zy8uqFSRDKaxEM8FJetpMWOZ0vR6yg4AGqGtMlLJ_0NSxIE_tqSnOsPd9aLWtg8/pub?output=csv";
        const ENEMY_GID = "322780304";
        const CARD_GID = "0";

        let state = {
            playerHP: 100,
            energy: 3,
            maxEnergy: 3,
            round: 1,
            allCards: [],
            enemyPool: [],
            currentEnemy: null,
            enemyIndex: 0
        };

        // 初始化：讀取 Google Sheets
        async function initGame() {
            // 讀取卡牌 (GID: 0)
            Papa.parse(`${BASE_CSV_URL}&gid=${CARD_GID}`, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    state.allCards = results.data
                        .filter(row => row.Name) // 確保有名字
                        .map((r, i) => ({...r, row: i + 2}));
                    drawCards(5);
                    updateUI();
                }
            });

            // 讀取敵人 (GID: 322780304)
            Papa.parse(`${BASE_CSV_URL}&gid=${ENEMY_GID}`, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    state.enemyPool = results.data
                        .filter(row => row.Name)
                        .map((r, i) => ({...r, row: i + 2}));
                    loadEnemy();
                }
            });
        }

        function loadEnemy() {
            if (state.enemyIndex < state.enemyPool.length) {
                let data = state.enemyPool[state.enemyIndex];
                state.currentEnemy = { ...data, curHP: parseInt(data.HP) };
                updateEnemyUI();
            } else {
                document.getElementById('enemy-name').innerText = "VICTORY!";
            }
        }

        function updateEnemyUI() {
            if(!state.currentEnemy) return;
            const en = state.currentEnemy;
            document.getElementById('enemy-name').innerText = en.Name;
            document.getElementById('enemy-row-display').innerText = `Sheet Row: ${en.row}`;
            document.getElementById('enemies-left').innerText = state.enemyPool.length - state.enemyIndex;
            
            const pct = (en.curHP / en.HP) * 100;
            document.getElementById('enemy-hp-fill').style.width = pct + '%';
            document.getElementById('enemy-hp-text').innerText = `${en.curHP} / ${en.HP}`;
            
            const zone = document.getElementById('active-enemy-zone');
            zone.className = `enemy-box type-${en.Type || 1}`;
        }

        function drawCards(num) {
            const hand = document.getElementById('hand-area');
            hand.innerHTML = '';
            for(let i=0; i<num; i++){
                const data = state.allCards[Math.floor(Math.random()*state.allCards.length)];
                if(!data) continue;
                
                const el = document.createElement('div');
                el.className = 'card';
                el.innerHTML = `
                    <div class="card-cost-tag">${data.Cost}</div>
                    <div style="font-family:'Rye'; padding:15px; text-align:center; font-size:1.1rem; border-bottom:1px solid #ddd">${data.Name}</div>
                    <div style="padding:15px; font-size:0.9rem; text-align:center; line-height:1.4">${data.Effect}</div>
                    <div class="card-row-tag">Row:${data.row}</div>
                `;
                bindDrag(el, data);
                hand.appendChild(el);
            }
        }

        function bindDrag(el, data) {
            el.onmousedown = (e) => {
                if(state.energy < parseInt(data.Cost)) {
                    el.style.borderColor = "red";
                    setTimeout(() => el.style.borderColor = "", 300);
                    return;
                }

                const rect = el.getBoundingClientRect();
                el.classList.add('dragging');

                function moveAt(pageX, pageY) {
                    el.style.left = pageX - (rect.width / 2) + 'px';
                    el.style.top = pageY - (rect.height / 2) - 20 + 'px';
                }

                moveAt(e.pageX, e.pageY);

                function onMouseMove(ev) {
                    moveAt(ev.pageX, ev.pageY);
                    const target = document.elementFromPoint(ev.clientX, ev.clientY);
                    const zone = document.getElementById('active-enemy-zone');
                    if(zone.contains(target)) zone.style.borderColor = "var(--steam-blue)";
                    else zone.style.borderColor = "";
                }

                document.addEventListener('mousemove', onMouseMove);

                document.onmouseup = (ev) => {
                    document.removeEventListener('mousemove', onMouseMove);
                    const target = document.elementFromPoint(ev.clientX, ev.clientY);
                    const zone = document.getElementById('active-enemy-zone');

                    if(zone && zone.contains(target)) {
                        applyEffect(data.Effect);
                        state.energy -= parseInt(data.Cost);
                        el.remove();
                    } else {
                        el.classList.remove('dragging');
                        el.style.position = ''; el.style.left = ''; el.style.top = '';
                    }
                    zone.style.borderColor = "";
                    updateUI();
                    document.onmouseup = null;
                };
            };
        }

        function applyEffect(effect) {
            const regex = /\[#(\w+)\s+(-?\d+)\]/g;
            let match;
            while ((match = regex.exec(effect)) !== null) {
                const tag = match[1];
                const val = parseInt(match[2]);
                if(tag === 'dmg') state.currentEnemy.curHP -= val;
                if(tag === 'heal') state.playerHP = Math.min(100, state.playerHP + val);
                if(tag === 'nextround') { state.round++; state.enemyIndex++; loadEnemy(); }
            }

            if(state.currentEnemy.curHP <= 0) {
                state.enemyIndex++;
                state.round++; // 根據您的需求：消滅敵人後增加 Round
                loadEnemy();
            } else {
                updateEnemyUI();
            }
        }

        function updateUI() {
            document.getElementById('energy-val').innerText = `${state.energy}/${state.maxEnergy}`;
            document.getElementById('round-val').innerText = state.round;
        }

        document.getElementById('end-action-btn').onclick = () => {
            state.energy = state.maxEnergy;
            drawCards(5);
            updateUI();
        };

        window.onload = initGame;
    </script>
</body>
</html>
